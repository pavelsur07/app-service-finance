# План систематизации кода

Документ фиксирует поэтапный план приведения кодовой базы в упорядоченное состояние.
Рефакторинг выполняется строго по этапам и только атомарными PR.

## Цель
- остановить рост хаотичной структуры
- зафиксировать модульный подход как основной
- снизить риски поломок при рефакторинге
- обеспечить предсказуемое развитие проекта

## Общие принципы
- Рефакторинг выполняется итерациями.
- 1 PR = 1 атомарное изменение.
- Массовые переносы и «большие рефакторинги» запрещены.
- Всегда должен проходить `composer test:smoke`.
- Сначала порядок и структура, потом оптимизация и улучшения.

## Этап 0 — База (зафиксировано)
Статус: выполнено.

- Зафиксированы правила архитектуры.
- Зафиксированы правила документации.
- Зафиксированы правила разработки.
- Добавлены test:smoke / test:all / test:no-legacy.
- Подготовлены Codex-шаблоны.

## Этап 1 — Шаблоны и UI (низкий риск)
Цель: навести порядок без затрагивания бизнес-логики.

Приоритетные задачи:
- удаление мусорных и дублирующихся Twig-файлов
- приведение partials к единому месту
- внедрение Twig namespaces
- выравнивание структуры templates по модулям

Ограничения:
- не менять бизнес-логику
- не менять сервисы и сущности

## Этап 2 — Изолированные модули
Цель: получить эталон правильно оформленного модуля.

Рекомендуемая очередность:
1. Telegram
2. Loan
3. Balance

Для каждого модуля:
- контроллеры, сервисы, сущности и формы находятся внутри модуля
- шаблоны изолированы
- тесты разложены по модулю
- отсутствуют новые зависимости от legacy-кода

## Этап 3 — Legacy-код (Service / Controller)
Цель: прекратить рост legacy и постепенно уменьшать его роль.

Принципы:
- legacy-код не удаляется массово
- логика постепенно выносится в модули
- legacy остаётся, но перестаёт расти
- новые фичи в legacy запрещены

## Этап 4 — Интеграции и Marketplace
Цель: упорядочить самые сложные и связанные части системы.

Особенности:
- выполняется только после стабилизации предыдущих этапов
- только по одному модулю или интеграции за PR
- обязательная проверка smoke

## Definition of Done для этапов
Этап считается завершённым, если:
- `composer test:smoke` проходит
- не добавлен новый код в legacy-папки
- структура соответствует правилам проекта
- документация обновлена при необходимости

## Запреты
- Нельзя выполнять рефакторинг вне этого плана.
- Нельзя перескакивать этапы.
- Нельзя объединять несколько этапов в одном PR.

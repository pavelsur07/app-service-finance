# План систематизации кода

Документ фиксирует поэтапный план приведения кодовой базы в упорядоченное состояние.
Рефакторинг выполняется строго по этапам и только атомарными PR.

## Цель
- остановить рост хаотичной структуры
- зафиксировать модульный подход как основной
- снизить риски поломок при рефакторинге
- обеспечить предсказуемое развитие проекта

## Общие принципы
- Рефакторинг выполняется итерациями.
- 1 PR = 1 атомарное изменение.
- Массовые переносы и «большие рефакторинги» запрещены.
- Всегда должен проходить `composer test:smoke`.
- Сначала порядок и структура, потом оптимизация и улучшения.

## Этап 0 — База (зафиксировано)
Статус: выполнено.

- Зафиксированы правила архитектуры.
- Зафиксированы правила документации.
- Зафиксированы правила разработки.
- Добавлены test:smoke / test:all / test:no-legacy.
- Подготовлены Codex-шаблоны.

## Этап 1 — Шаблоны и UI (низкий риск)
Цель: навести порядок без затрагивания бизнес-логики.

Приоритетные задачи:
- удаление мусорных и дублирующихся Twig-файлов
- приведение partials к единому месту
- внедрение Twig namespaces
- выравнивание структуры templates по модулям

Ограничения:
- не менять бизнес-логику
- не менять сервисы и сущности

## Этап 2 — Изолированные модули
Цель: получить эталон правильно оформленного модуля.

Рекомендуемая очередность:
1. Telegram
2. Loan
3. Balance

Для каждого модуля:
- контроллеры, сервисы, сущности и формы находятся внутри модуля
- шаблоны изолированы
- тесты разложены по модулю
- отсутствуют новые зависимости от legacy-кода

## Этап 3 — Legacy-код (Service / Controller)
Цель: прекратить рост legacy и постепенно уменьшать его роль.

Принципы:
- legacy-код не удаляется массово
- логика постепенно выносится в модули
- legacy остаётся, но перестаёт расти
- новые фичи в legacy запрещены

## Этап 4 — Интеграции и Marketplace
Цель: упорядочить самые сложные и связанные части системы.

Особенности:
- выполняется только после стабилизации предыдущих этапов
- только по одному модулю или интеграции за PR
- обязательная проверка smoke

## Definition of Done для этапов
Этап считается завершённым, если:
- `composer test:smoke` проходит
- не добавлен новый код в legacy-папки
- структура соответствует правилам проекта
- документация обновлена при необходимости

## Запреты
- Нельзя выполнять рефакторинг вне этого плана.
- Нельзя перескакивать этапы.
- Нельзя объединять несколько этапов в одном PR.

--- BEGIN FULL PROJECT REFACTORING PLAN ---

# Финальный план систематизации проекта

## Зафиксированные решения
- Cash — единый модуль ДДС.
- Accounts (MoneyAccount, MoneyFund) являются частью Cash.
- PaymentPlan и ImportLog относятся к Cash.
- PnL является частью Finance.
- Document и DocumentOperation — PnL-операции внутри Finance.
- Отдельные модули Accounts и PaymentPlan не создаются.
- Для MVP используется внутримодульная группировка папками.

## Целевая карта модулей
Существующие модули: Ai, Balance, Banking, Finance, Loan, Marketplace, Telegram, Notification, Admin, Report.
Формализованные модули: Company, Cash, Finance, Report.

## Структура модуля Cash
Внутри Cash допускается группировка по папкам:
Accounts, Transaction, PaymentPlan, Import.
Подмодули не создаются.

## Очередность рефакторинга
Этап 1 — UI / Twig.
Этап 2 — Контроллеры.
Этап 3 — Сервисы.
Этап 4 — Forms → Repositories → Entities.

## Definition of Done
- composer test:smoke проходит
- legacy-папки не растут
- изменения атомарны
- документация обновлена

## Запреты
- массовые переносы
- объединение этапов
- архитектурные эксперименты

--- END FULL PROJECT REFACTORING PLAN ---

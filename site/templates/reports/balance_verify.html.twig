{% extends 'base.html.twig' %}

{% block breadcrumbs %}
    {% include 'partials/_breadcrumbs.html.twig' with {
        breadcrumbs: [
            {'label': 'Главная', 'path': 'app_home_index'},
            {'label': 'Отчеты'},
            {'label': 'Контроль пересчёта остатков', 'path': 'app_reports_balance_verify'}
        ]
    } %}
{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-3">
    <h2 class="page-title">Контроль пересчёта остатков</h2>
</div>

<form method="post" class="row g-2 mb-4">
    <input type="hidden" name="_token" value="{{ csrf_token('balance_verify') }}"/>
    <div class="col-12 col-md-3">
        <select name="account_id" class="form-select">
            {% for acc in accounts %}
                <option value="{{ acc.id }}" {% if acc.id == selected_account_id %}selected{% endif %}>{{ acc.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <input type="date" name="from" value="{{ date_from|date('Y-m-d') }}" class="form-control"/>
    </div>
    <div class="col-auto">
        <input type="date" name="to" value="{{ date_to|date('Y-m-d') }}" class="form-control"/>
    </div>
    <div class="col-12">
        <label class="form-check">
            <input type="checkbox" name="recalc" value="1" class="form-check-input" {% if recalc %}checked{% endif %}>
            <span class="form-check-label">Пересчитать перед проверкой</span>
        </label>
    </div>
    <div class="col-12">
        <textarea name="expected_json" rows="12" class="form-control">{{ expected_json }}</textarea>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-primary">Проверить</button>
    </div>
</form>

{% if resultRows is not null %}
<div class="card mb-3">
    <div class="card-body">
        <p class="mb-3">OK: {{ totals.ok }} rows verified, {{ totals.mismatches }} mismatches</p>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Opening [exp|act]</th>
                    <th>Inflow [exp|act]</th>
                    <th>Outflow [exp|act]</th>
                    <th>Closing [exp|act]</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                {% for row in resultRows %}
                    {% set status = row.status %}
                    {% set color = 'text-warning' %}
                    {% if status == 'OK' %}
                        {% set color = 'text-success' %}
                    {% elseif status in ['MISMATCH', 'CONSISTENCY_FAIL'] %}
                        {% set color = 'text-danger' %}
                    {% endif %}
                    <tr class="{{ color }}">
                        <td>{{ row.date }}</td>
                        <td>{{ row.expected.opening ?? '-' }} | {{ row.actual.opening ?? '-' }}</td>
                        <td>{{ row.expected.inflow ?? '-' }} | {{ row.actual.inflow ?? '-' }}</td>
                        <td>{{ row.expected.outflow ?? '-' }} | {{ row.actual.outflow ?? '-' }}</td>
                        <td>{{ row.expected.closing ?? '-' }} | {{ row.actual.closing ?? '-' }}</td>
                        <td>
                            {% if status == 'OK' %}
                                <span class="badge bg-success">OK</span>
                            {% elseif status == 'MISMATCH' %}
                                <span class="badge bg-danger">MISMATCH</span>
                            {% elseif status == 'CONSISTENCY_FAIL' %}
                                <span class="badge bg-danger">CONSISTENCY_FAIL</span>
                            {% elseif status == 'MISSING' %}
                                <span class="badge bg-warning text-dark">MISSING</span>
                            {% elseif status == 'UNEXPECTED' %}
                                <span class="badge bg-warning text-dark">UNEXPECTED</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

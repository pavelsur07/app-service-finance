{% set current_route = app.request ? app.request.attributes.get('_route') : '' %}
{% set user_roles = [] %}
{% if app.user %}
    {% set user_roles = app.user.roles|default([]) %}
{% endif %}
<style>
    :root{
        --brand:#0A1548; /* основной брендовый */
        --brand-05: rgba(10,21,72,.05);
        --sidebar-w: 280px;
        --sidebar-w-collapsed: 80px;
    }
    .nav-item.active > a { background: var(--brand-05); color: var(--brand); border-left: 2px solid var(--brand); }
    .nav-item a:hover { background: var(--brand-05); color: var(--brand); }
    .nav-section-title { font-size:.75rem; letter-spacing:.04em; color:#8a94a6; text-transform:uppercase; padding: .5rem 1rem; }
    .nav-link-icon i { font-size: 1.5em; line-height: 1; }
    aside.navbar .navbar-brand { display: flex; align-items: center; justify-content: flex-start; padding-inline: .75rem; margin-bottom: 0; }
    .navbar-brand img { height: 40px; width: auto; }
</style>

<!-- Sidebar -->

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu" aria-controls="sidebar-menu" aria-expanded="false" aria-label="Переключить навигацию">
        <span class="navbar-toggler-icon"></span>
    </button>
    <h1 class="navbar-brand navbar-brand-autodark mb-0">
        <a href="{{ path('app_home_index') }}">
            <img src="{{ asset('logo-vf-001.png') }}" alt="Ваш ФинДир" />
        </a>
    </h1>
    <div class="collapse navbar-collapse" id="sidebar-menu">

        <ul class="navbar-nav">
            <!-- Dashboard -->
            {% set dashboard_active = current_route == 'app_home_index' %}
            <li class="nav-item {{ dashboard_active ? 'active' : '' }}">
                <a class="nav-link {{ dashboard_active ? 'active' : '' }}" href="{{ path('app_home_index') }}" title="Главная">
                    <span class="nav-link-icon"><i class="ti ti-home"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Главная</span>
                </a>
            </li>

            <!-- Деньги -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#navbar-base" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="false">
                    <span class="nav-link-icon"><i class="ti ti-wallet"></i></span>
                    <span class="nav-link-title"> Деньги </span>
                </a>
                <div class="dropdown-menu">
                    <div class="dropdown-menu-columns">
                        <div class="dropdown-menu-column">
                            <a class="dropdown-item" href="{{ path('cash_transaction_index') }}">
                                Операции ДДС
                                <span class="badge badge-sm bg-green-lt text-uppercase ms-auto">New</span>
                            </a>
                            <a class="dropdown-item" href="{{ path('finance_funds_index') }}">Фонды (конверты) </a>
                            <a class="dropdown-item" href="{{ path('payment_calendar_index') }}">Платежный календарь </a>
                            <a class="dropdown-item" href="{{ path('report_account_balances_structured_index') }}">Остатки и счета </a>
                            {#<a class="dropdown-item" href="#">Движение денег </a>#}
                        </div>
                    </div>
                </div>
            </li>
            <!-- Деньги -->

            <!-- ОПиУ -->
            {% set documents_active = current_route == 'document_index' %}
            <li class="nav-item {{ documents_active ? 'active' : '' }}">
                <a class="nav-link {{ documents_active ? 'active' : '' }}" href="{{ path('document_index') }}" title="Документы ОПиУ">
                    <span class="nav-link-icon"><i class="ti ti-file-invoice"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Доходы и расходы</span>
                </a>
            </li>
            <!-- ОПиУ -->

            {% set deals_path = app.request ? app.request.pathinfo : '' %}
            {% set deals_active = deals_path starts with '/deals' %}
            <li class="nav-item dropdown {{ deals_active ? 'show' : '' }}">
                <a class="nav-link dropdown-toggle {{ deals_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ deals_active ? 'true' : 'false' }}">
                    <span class="nav-link-icon"><i class="ti ti-briefcase"></i></span>
                    <span class="nav-link-title">Сделки</span>
                </a>
                {% set deals_show = deals_active ? 'show' : '' %}
                <div class="dropdown-menu {{ deals_show }}">
                    <div class="dropdown-menu-column">
                        {% set deal_index_active = current_route == 'deal_index' %}
                        <a class="dropdown-item {{ deal_index_active ? 'active' : '' }}" href="{{ path('deal_index') }}">
                            <span>Реестр сделок</span>
                        </a>
                        {% set deal_new_active = current_route == 'deal_new' %}
                        <a class="dropdown-item {{ deal_new_active ? 'active' : '' }}" href="{{ path('deal_new') }}">
                            <span>Создать сделку</span>
                        </a>
                        {% set deal_charge_types_active = deals_path == '/deals/charge-types' %}
                        <a class="dropdown-item {{ deal_charge_types_active ? 'active' : '' }}" href="/deals/charge-types">
                            <span>Типы расходов</span>
                        </a>
                    </div>
                </div>
            </li>

            {#{% set cash_transactions_active = current_route == 'cash_transaction_index' %}
            <li class="nav-item {{ cash_transactions_active ? 'active' : '' }}">
                <a class="nav-link {{ cash_transactions_active ? 'active' : '' }}" href="{{ path('cash_transaction_index') }}" title="Операции ДДС">
                    <span class="nav-link-icon"><i class="ti ti-arrows-exchange"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Операции</span>
                </a>
            </li>#}

           {# {% set report_account_balances_structured_active = current_route == 'report_account_balances_structured_index' %}
            <li class="nav-item {{ report_account_balances_structured_active ? 'active' : '' }}">
                <a class="nav-link {{ report_account_balances_structured_active ? 'active' : '' }}" href="{{ path('report_account_balances_structured_index') }}" title="Остатки и счета (структура)">
                    <span class="nav-link-icon"><i class="ti ti-wallet"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Остатки и счета</span>
                </a>
            </li>#}

            {#{% set finance_funds_active = current_route == 'finance_funds_index' %}
            <li class="nav-item {{ finance_funds_active ? 'active' : '' }}">
                <a class="nav-link {{ finance_funds_active ? 'active' : '' }}"  href="{{ path('finance_funds_index') }}" title="Фонды (конверты)">
                    <span class="nav-link-icon"><i class="ti ti-pig-money"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Фонды (конверты)</span>
                </a>
            </li>#}

            {#{% set payment_calendar_active = current_route == 'payment_calendar_index' %}
            <li class="nav-item {{ payment_calendar_active ? 'active' : '' }}">
                <a class="nav-link {{ payment_calendar_active ? 'active' : '' }}" href="{{ path('payment_calendar_index') }}" title="Планирование">
                    <span class="nav-link-icon"><i class="ti ti-calendar-due"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Платежный календарь</span>
                </a>
            </li>#}

            {% set loans_active = current_route starts with 'loan_' %}
            <li class="nav-item {{ loans_active ? 'active' : '' }}">
                <a class="nav-link {{ loans_active ? 'active' : '' }}" href="{{ path('loan_index') }}" title="Кредиты">
                    <span class="nav-link-icon"><i class="ti ti-building-bank"></i></span>
                    <span class="nav-link-title hide-when-collapsed">Кредиты</span>
                </a>
            </li>

            {% include "partials/_sidebar_report.html.twig" %}

            <!-- Справочники -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#navbar-base" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="false">
                    <span class="nav-link-icon"><i class="ti ti-books"></i></span>
                    <span class="nav-link-title"> Справочники </span>
                </a>
                <div class="dropdown-menu">
                    <div class="dropdown-menu-columns">
                        <div class="dropdown-menu-column">
                            <a class="dropdown-item" href="{{ path('cashflow_category_index') }}">Категории ДДС</a>
                            <a class="dropdown-item" href="{{ path('pl_category_index') }}">Категории ОПиУ</a>
                            <a class="dropdown-item" href="{{ path('balance_structure_index') }}">Настройка баланса</a>
                            <a class="dropdown-item" href="{{ path('money_account_index') }}">Счета и кассы</a>
                            <a class="dropdown-item" href="{{ path('counterparty_index') }}">Контрагенты</a>
                            <a class="dropdown-item" href="{{ path('project_direction_index') }}">Проекты</a>
                            <a class="dropdown-item" href="{{ path('cash_transaction_auto_rule_index') }}">Автоправила ДДС</a>
                        </div>
                    </div>
                </div>
            </li>
            <!-- Справочники -->


            {% set handbooks_menu_open =
                current_route == 'cashflow_category_index'
                or current_route == 'pl_category_index'
                or current_route starts with 'balance_structure_'
                or current_route == 'money_account_index'
                or current_route == 'counterparty_index'
                or current_route == 'project_direction_index'
                or current_route == 'cash_transaction_auto_rule_index'
            %}


            <!-- Импорт -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#navbar-base" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="false">
                    <span class="nav-link-icon"><i class="ti ti-download"></i></span>
                    <span class="nav-link-title"> Импорт </span>
                </a>
                <div class="dropdown-menu">
                    <div class="dropdown-menu-columns">
                        <div class="dropdown-menu-column">
                            <a class="dropdown-item" href="{{ path('cash_bank1c_import_upload') }}">
                                Импорт выписок 1С
                            </a>
                            <a class="dropdown-item" href="#">
                                Импорт касса xlsx/csv
                            </a>
                            <a class="dropdown-item" href="{{ path('import_logs_index') }}">Журнал импорта </a>
                        </div>
                    </div>
                </div>
            </li>




            {% set integrations_active =
                current_route starts with 'ozon_'
                or current_route starts with 'wildberries_'
                or current_route starts with 'telegram_integration_'
                or current_route starts with 'cash_bank_connection_'
                or current_route starts with 'integrations_marketplace_'
            %}
            <li class="nav-item dropdown {{ integrations_active ? 'show' : '' }}">
                <a class="nav-link dropdown-toggle {{ integrations_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ integrations_active ? 'true' : 'false' }}">
                    <span class="nav-link-title">Интеграции</span>
                </a>
                {% set integrations_show = (
                    integrations_active
                    or current_route starts with 'ozon_'
                    or current_route starts with 'wildberries_'
                    or current_route starts with 'telegram_integration_'
                    or current_route starts with 'cash_bank_connection_'
                    or current_route starts with 'marketplace_'
                    or current_route starts with 'integrations_marketplace_'
                ) ? 'show' : '' %}
                    <div class="dropdown-menu {{ integrations_show }}">
                        <div class="dropdown-menu-column">
                            {% set telegram_finance_active = current_route starts with 'telegram_integration_' %}
                            <a class="dropdown-item {{ telegram_finance_active ? 'active' : '' }}" href="{{ path('telegram_integration_index') }}">
                                <span>Telegram / Финансы</span>
                            </a>
                            {% set bank_connections_active = current_route starts with 'cash_bank_connection_' %}
                            <a class="dropdown-item {{ bank_connections_active ? 'active' : '' }}" href="{{ path('cash_bank_connection_index') }}">
                                <span>Банки / Подключения</span>
                            </a>

                            {% set marketplace_active = current_route starts with 'marketplace_' %}
                            <a class="dropdown-item {{ marketplace_active ? 'active' : '' }}" href="{{ path('marketplace_index') }}">
                                <span>Маркетплейсы</span>
                            </a>

                            {% set marketplace_sales_active = current_route starts with 'marketplace_sales_' %}
                            <a class="dropdown-item {{ marketplace_sales_active ? 'active' : '' }}" href="{{ path('marketplace_sales_index') }}">
                                <span>Продажи WB</span>
                            </a>

                            {% set marketplace_returns_active = current_route starts with 'marketplace_returns_' %}
                            <a class="dropdown-item {{ marketplace_returns_active ? 'active' : '' }}" href="{{ path('marketplace_returns_index') }}">
                                <span>Возвраты WB</span>
                            </a>

                            {% set marketplace_costs_active = current_route starts with 'marketplace_costs_' %}
                            <a class="dropdown-item {{ marketplace_costs_active ? 'active' : '' }}" href="{{ path('marketplace_costs_index') }}">
                                <span>Затраты WB</span>
                            </a>

                            {% set marketplace_products_active = current_route starts with 'marketplace_products_' %}
                            <a class="dropdown-item {{ marketplace_products_active ? 'active' : '' }}" href="{{ path('marketplace_products_index') }}">
                                <span>Товары WB</span>
                            </a>

                            {% set marketplace_active = current_route starts with 'integrations_marketplace_' %}
                            <a class="dropdown-item {{ marketplace_active ? 'active' : '' }}" href="{{ path('integrations_marketplace_index') }}">
                                <span>Маркетплейс интеграций</span>
                            </a>
                    </div>
                </div>
            </li>

            {% set company_users_active =
                current_route starts with 'company_users_'
                or current_route starts with 'company_member_'
                or current_route starts with 'company_invite_'
            %}
            {% set company_active = current_route starts with 'company_' or current_route starts with 'settings_report_api_key_' or company_users_active %}
            <li class="nav-item dropdown {{ company_active ? 'show' : '' }}">
                <a class="nav-link dropdown-toggle {{ company_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ company_active ? 'true' : 'false' }}">
                    <span class="nav-link-title">Компания и доступ</span>
                </a>
                {% set company_show = (company_active or current_route starts with 'company_' or current_route starts with 'settings_report_api_key_' or company_users_active) ? 'show' : '' %}
                <div class="dropdown-menu {{ company_show }}">
                    <div class="dropdown-menu-column">
                        {% set company_profile_active = current_route in ['company_index', 'company_new', 'company_show', 'company_edit'] %}
                        <a class="dropdown-item {{ company_profile_active ? 'active' : '' }}" href="{{ path('company_index') }}">
                            <span>Профиль компании</span>
                        </a>

                        <a class="dropdown-item {{ company_users_active ? 'active' : '' }}" href="{{ path('company_users_index') }}">
                            <span>Пользователи</span>
                        </a>

                        {% set company_price_active = current_route starts with 'company_price_' %}
                        <a class="dropdown-item {{ company_price_active ? 'active' : '' }}" href="{{ path('company_price_index') }}">
                            <span>Тарифы</span>
                        </a>

                        {% set report_api_key_active = current_route starts with 'settings_report_api_key_' %}
                        <a class="dropdown-item {{ report_api_key_active ? 'active' : '' }}" href="{{ path('settings_report_api_key_index') }}">
                            <span>Настройки отчётов (API-ключ)</span>
                        </a>

                        {% set reports_debug_active =
                            current_route starts with 'report_transactions_statement_'
                            or current_route starts with 'report_transactions_debug_'
                            or current_route starts with 'report_debug_'
                            or current_route starts with 'finance_report_raw'
                            or current_route starts with 'finance_report_pl_raw'
                        %}
                        <div class="dropend {{ reports_debug_active ? 'show' : '' }}">
                            <a class="dropdown-item dropdown-toggle {{ reports_debug_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ reports_debug_active ? 'true' : 'false' }}">
                                <span>Отладка</span>
                            </a>
                            {% set reports_debug_show = (
                                reports_debug_active
                                or current_route starts with 'report_transactions_statement_'
                                or current_route starts with 'report_debug_'
                                or current_route starts with 'finance_report_raw'
                                or current_route starts with 'finance_report_pl_raw'
                            ) ? 'show' : '' %}
                            <div class="dropdown-menu {{ reports_debug_show }}">
                                {% set report_statement_active = current_route starts with 'report_transactions_statement_' %}
                                <a class="dropdown-item {{ report_statement_active ? 'active' : '' }}" href="{{ path('report_transactions_statement_index') }}">
                                    <span>Выписка/Стейтмент</span>
                                </a>
{#                                {% set report_debug_active = current_route starts with 'report_transactions_debug_' %}
                                <a class="dropdown-item {{ report_debug_active ? 'active' : '' }}" href="{{ path('report_transactions_debug_index') }}">
                                    <span>Отчёт отладка</span>
                                </a>#}
                               {# {% set report_raw_transactions_active = current_route starts with 'report_debug_transactions_raw' %}
                                <a class="dropdown-item {{ report_raw_transactions_active ? 'active' : '' }}" href="{{ path('report_debug_transactions_raw') }}">
                                    <span>Отчёт «Сырые транзакции»</span>
                                </a>#}
                                {#{% set report_daily_facts_active = current_route starts with 'report_debug_daily_facts' %}
                                <a class="dropdown-item {{ report_daily_facts_active ? 'active' : '' }}" href="{{ path('report_debug_daily_facts') }}">
                                    <span>Отчёт «Фактические дневные остатки»</span>
                                </a>#}
                                {% set finance_report_raw_active = current_route starts with 'finance_report_raw' %}
                                <a class="dropdown-item {{ finance_report_raw_active ? 'active' : '' }}" href="{{ path('finance_report_raw') }}">
                                    <span>Сырые транзакции ОПиУ</span>
                                </a>
                                {% set finance_report_pl_raw_active = current_route starts with 'finance_report_pl_raw' %}
                                <a class="dropdown-item {{ finance_report_pl_raw_active ? 'active' : '' }}" href="{{ path('finance_report_pl_raw') }}">
                                    <span>Сырые данные ОПиУ</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>

{% macro is_active(current_route, patterns) -%}
    {%- set result = false -%}
    {%- for p in patterns -%}
        {%- if p is not empty and (current_route == p or current_route starts with p) -%}
            {%- set result = true -%}
        {%- endif -%}
    {%- endfor -%}
    {{- result -}}
{%- endmacro %}

{% macro collapse_state(current_route, prefix) -%}
    {{- current_route starts with prefix ? 'show' : '' -}}
{%- endmacro %}

{% import _self as macros %}

{% set current_route = app.request ? app.request.attributes.get('_route') : '' %}
{% set user_roles = [] %}
{% if app.user %}
    {% set user_roles = app.user.roles|default([]) %}
{% endif %}

<aside class="navbar navbar-vertical navbar-expand-lg navbar-transparent" data-bs-theme="light">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu" aria-controls="sidebar-menu" aria-expanded="false" aria-label="Переключить навигацию">
            <span class="navbar-toggler-icon"></span>
        </button>
        <h1 class="navbar-brand navbar-brand-autodark">
            <a href="{{ path('app_home_index') }}">Финансы</a>
        </h1>
        <div class="collapse navbar-collapse" id="sidebar-menu">
            <ul class="navbar-nav pt-lg-3">
                {% set dashboard_active = macros.is_active(current_route, ['app_home_index']) %}
                <li class="nav-item">
                    <a class="nav-link {{ dashboard_active ? 'active' : '' }}" href="{{ path('app_home_index') }}">
                        <span class="nav-link-title">Главная</span>
                    </a>
                </li>

                {% set money_active = macros.is_active(current_route, ['cash_transaction_', 'report_account_balances', 'finance_funds_']) %}
                <li class="nav-item dropdown {{ money_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ money_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ money_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Деньги</span>
                    </a>
                    <div class="dropdown-menu {{ money_active ? 'show' : '' }}">
                        <div class="dropdown-menu-column">
                            {% set cash_transactions_active = macros.is_active(current_route, ['cash_transaction_index', 'cash_transaction_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ cash_transactions_active ? 'active' : '' }}" href="{{ path('cash_transaction_index') }}">
                                <span class="flex-fill">Операций ДДС</span>
                            </a>
                            {% set account_balances_active = macros.is_active(current_route, ['report_account_balances']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ account_balances_active ? 'active' : '' }}" href="{{ path('report_account_balances_index') }}">
                                <span class="flex-fill">Остатки и счета</span>
                            </a>
                            {% if is_funds_feature_enabled() %}
                                {% set funds_active = macros.is_active(current_route, ['finance_funds_']) %}
                                <a class="dropdown-item d-flex align-items-center justify-content-between {{ funds_active ? 'active' : '' }}" href="{{ path('finance_funds_index') }}">
                                    <span class="flex-fill">Фонды (конверты)</span>
                                </a>
                            {% endif %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Переводы</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Сверка</span>
                            </a>
                        </div>
                    </div>
                </li>

                {% set documents_active = macros.is_active(current_route, ['document_']) %}
                <li class="nav-item dropdown {{ documents_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ documents_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ documents_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Документы ОПиУ</span>
                    </a>
                    {% set documents_show = documents_active ? 'show' : macros.collapse_state(current_route, 'document_') %}
                    <div class="dropdown-menu {{ documents_show }}">
                        <div class="dropdown-menu-column">
                            {% set documents_index_active = macros.is_active(current_route, ['document_index', 'document_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ documents_index_active ? 'active' : '' }}" href="{{ path('document_index') }}">
                                <span class="flex-fill">Реестр документов</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Карточка документа</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Правила маппинга ОПиУ</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Качество данных</span>
                            </a>
                        </div>
                    </div>
                </li>

                {% set import_active = macros.is_active(current_route, ['cash_bank1c_import_upload', 'import_logs_', 'cash_transaction_auto_rule_']) %}
                <li class="nav-item dropdown {{ import_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ import_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ import_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Импорт</span>
                    </a>
                    {% set import_show = import_active ? 'show' : (macros.collapse_state(current_route, 'import_') ?: macros.collapse_state(current_route, 'cash_transaction_auto_rule_')) %}
                    <div class="dropdown-menu {{ import_show }}">
                        <div class="dropdown-menu-column">
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Импорт документов</span>
                            </a>
                            {% set bank_import_active = macros.is_active(current_route, ['cash_bank1c_import_upload']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ bank_import_active ? 'active' : '' }}" href="{{ path('cash_bank1c_import_upload') }}">
                                <span class="flex-fill">Импорт выписок 1C</span>
                            </a>
                            {% set import_logs_active = macros.is_active(current_route, ['import_logs_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ import_logs_active ? 'active' : '' }}" href="{{ path('import_logs_index') }}">
                                <span class="flex-fill">Журнал импортов</span>
                            </a>
                            {% set auto_rules_active = macros.is_active(current_route, ['cash_transaction_auto_rule_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ auto_rules_active ? 'active' : '' }}" href="{{ path('cash_transaction_auto_rule_index') }}">
                                <span class="flex-fill">Автоправила ДДС</span>
                            </a>
                        </div>
                    </div>
                </li>

                {% set planning_active = macros.is_active(current_route, ['payment_calendar_']) %}
                <li class="nav-item dropdown {{ planning_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ planning_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ planning_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Планирование</span>
                    </a>
                    {% set planning_show = planning_active ? 'show' : macros.collapse_state(current_route, 'payment_calendar_') %}
                    <div class="dropdown-menu {{ planning_show }}">
                        <div class="dropdown-menu-column">
                            {% set payment_calendar_active = macros.is_active(current_route, ['payment_calendar_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ payment_calendar_active ? 'active' : '' }}" href="{{ path('payment_calendar_index') }}">
                                <span class="flex-fill">Платёжный календарь</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Планы платежей</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Кредиты и графики</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Депозиты</span>
                            </a>
                        </div>
                    </div>
                </li>

                {% set account_balances_route = current_route starts with 'report_account_balances' %}
                {% set reports_active = (not account_balances_route) and macros.is_active(current_route, ['report_cashflow_', 'finance_report_', 'report_transactions_statement_', 'report_transactions_debug_', 'report_debug_']) %}
                <li class="nav-item dropdown {{ reports_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ reports_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ reports_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Отчёты</span>
                    </a>
                    {% set reports_show_fallback = account_balances_route ? '' : (macros.collapse_state(current_route, 'report_') ?: macros.collapse_state(current_route, 'finance_report_')) %}
                    {% set reports_show = reports_active ? 'show' : reports_show_fallback %}
                    <div class="dropdown-menu {{ reports_show }}">
                        <div class="dropdown-menu-column">
                            {% set report_cashflow_active = macros.is_active(current_route, ['report_cashflow_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_cashflow_active ? 'active' : '' }}" href="{{ path('report_cashflow_index') }}">
                                <span class="flex-fill">ДДС (Cash Flow)</span>
                            </a>
                            {% set report_pnl_active = macros.is_active(current_route, ['finance_report_preview']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_pnl_active ? 'active' : '' }}" href="{{ path('finance_report_preview') }}">
                                <span class="flex-fill">ОПиУ (PnL)</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Упрощённый баланс</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Экспорт</span>
                            </a>
                            {% set reports_debug_active = macros.is_active(current_route, ['report_transactions_statement_', 'report_transactions_debug_', 'report_debug_', 'finance_report_raw', 'finance_report_pl_raw']) %}
                            <div class="dropend {{ reports_debug_active ? 'show' : '' }}">
                                <a class="dropdown-item dropdown-toggle d-flex align-items-center justify-content-between {{ reports_debug_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ reports_debug_active ? 'true' : 'false' }}">
                                    <span class="flex-fill">Отладка</span>
                                </a>
                                {% set reports_debug_show = reports_debug_active ? 'show' : (macros.collapse_state(current_route, 'report_transactions_statement_') ?: macros.collapse_state(current_route, 'report_debug_') ?: macros.collapse_state(current_route, 'finance_report_raw') ?: macros.collapse_state(current_route, 'finance_report_pl_raw')) %}
                                <div class="dropdown-menu {{ reports_debug_show }}">
                                    {% set report_statement_active = macros.is_active(current_route, ['report_transactions_statement_']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_statement_active ? 'active' : '' }}" href="{{ path('report_transactions_statement_index') }}">
                                        <span class="flex-fill">Выписка/Стейтмент</span>
                                    </a>
                                    {% set report_debug_active = macros.is_active(current_route, ['report_transactions_debug_']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_debug_active ? 'active' : '' }}" href="{{ path('report_transactions_debug_index') }}">
                                        <span class="flex-fill">Отчёт отладка</span>
                                    </a>
                                    {% set report_raw_transactions_active = macros.is_active(current_route, ['report_debug_transactions_raw']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_raw_transactions_active ? 'active' : '' }}" href="{{ path('report_debug_transactions_raw') }}">
                                        <span class="flex-fill">Отчёт «Сырые транзакции»</span>
                                    </a>
                                    {% set report_daily_facts_active = macros.is_active(current_route, ['report_debug_daily_facts']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_daily_facts_active ? 'active' : '' }}" href="{{ path('report_debug_daily_facts') }}">
                                        <span class="flex-fill">Отчёт «Фактические дневные остатки»</span>
                                    </a>
                                    {% set finance_report_raw_active = macros.is_active(current_route, ['finance_report_raw']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ finance_report_raw_active ? 'active' : '' }}" href="{{ path('finance_report_raw') }}">
                                        <span class="flex-fill">Сырые транзакции ОПиУ</span>
                                    </a>
                                    {% set finance_report_pl_raw_active = macros.is_active(current_route, ['finance_report_pl_raw']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ finance_report_pl_raw_active ? 'active' : '' }}" href="{{ path('finance_report_pl_raw') }}">
                                        <span class="flex-fill">Сырые данные ОПиУ</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

                {% set directories_active = macros.is_active(current_route, ['cashflow_category_', 'pl_category_', 'money_account_', 'counterparty_', 'project_direction_']) %}
                <li class="nav-item dropdown {{ directories_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ directories_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ directories_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Справочники</span>
                    </a>
                    {% set directories_show = directories_active ? 'show' : (macros.collapse_state(current_route, 'cashflow_category_') ?: macros.collapse_state(current_route, 'pl_category_') ?: macros.collapse_state(current_route, 'money_account_') ?: macros.collapse_state(current_route, 'counterparty_') ?: macros.collapse_state(current_route, 'project_direction_')) %}
                    <div class="dropdown-menu {{ directories_show }}">
                        <div class="dropdown-menu-column">
                            {% set cashflow_category_active = macros.is_active(current_route, ['cashflow_category_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ cashflow_category_active ? 'active' : '' }}" href="{{ path('cashflow_category_index') }}">
                                <span class="flex-fill">Категории ДДС</span>
                            </a>
                            {% set pl_category_active = macros.is_active(current_route, ['pl_category_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ pl_category_active ? 'active' : '' }}" href="{{ path('pl_category_index') }}">
                                <span class="flex-fill">Категории ОПиУ</span>
                            </a>
                            {% set money_account_active = macros.is_active(current_route, ['money_account_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ money_account_active ? 'active' : '' }}" href="{{ path('money_account_index') }}">
                                <span class="flex-fill">Счета / Кассы / Кошельки</span>
                            </a>
                            {% set counterparty_active = macros.is_active(current_route, ['counterparty_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ counterparty_active ? 'active' : '' }}" href="{{ path('counterparty_index') }}">
                                <span class="flex-fill">Контрагенты</span>
                            </a>
                            {% set project_direction_active = macros.is_active(current_route, ['project_direction_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ project_direction_active ? 'active' : '' }}" href="{{ path('project_direction_index') }}">
                                <span class="flex-fill">Проекты / ЦФО</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Теги</span>
                            </a>
                        </div>
                    </div>
                </li>

                {% set integrations_active = macros.is_active(current_route, ['ozon_', 'wildberries_']) %}
                <li class="nav-item dropdown {{ integrations_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ integrations_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ integrations_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Интеграции</span>
                    </a>
                    {% set integrations_show = integrations_active ? 'show' : (macros.collapse_state(current_route, 'ozon_') ?: macros.collapse_state(current_route, 'wildberries_')) %}
                    <div class="dropdown-menu {{ integrations_show }}">
                        <div class="dropdown-menu-column">
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">МойСклад</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">1С</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Банки</span>
                            </a>
                            {% set marketplaces_active = macros.is_active(current_route, ['ozon_', 'wildberries_']) %}
                            <div class="dropend {{ marketplaces_active ? 'show' : '' }}">
                                <a class="dropdown-item dropdown-toggle d-flex align-items-center justify-content-between {{ marketplaces_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ marketplaces_active ? 'true' : 'false' }}">
                                    <span class="flex-fill">Маркетплейсы</span>
                                </a>
                                {% set marketplaces_show = marketplaces_active ? 'show' : (macros.collapse_state(current_route, 'ozon_') ?: macros.collapse_state(current_route, 'wildberries_')) %}
                                <div class="dropdown-menu {{ marketplaces_show }}">
                                    {% set ozon_orders_active = macros.is_active(current_route, ['ozon_order']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ ozon_orders_active ? 'active' : '' }}" href="{{ path('ozon_orders') }}">
                                        <span class="flex-fill">Ozon / Заказы</span>
                                    </a>
                                    {% set ozon_products_active = macros.is_active(current_route, ['ozon_products']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ ozon_products_active ? 'active' : '' }}" href="{{ path('ozon_products') }}">
                                        <span class="flex-fill">Ozon / Товары</span>
                                    </a>
                                    {% set wildberries_sales_active = macros.is_active(current_route, ['wildberries_sales']) %}
                                    <a class="dropdown-item d-flex align-items-center justify-content-between {{ wildberries_sales_active ? 'active' : '' }}" href="{{ path('wildberries_sales') }}">
                                        <span class="flex-fill">Wildberries / Продажи</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

                {% set company_active = macros.is_active(current_route, ['company_', 'settings_report_api_key_']) %}
                <li class="nav-item dropdown {{ company_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ company_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ company_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Компания и доступ</span>
                    </a>
                    {% set company_show = company_active ? 'show' : (macros.collapse_state(current_route, 'company_') ?: macros.collapse_state(current_route, 'settings_report_api_key_')) %}
                    <div class="dropdown-menu {{ company_show }}">
                        <div class="dropdown-menu-column">
                            {% set company_profile_active = macros.is_active(current_route, ['company_index', 'company_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ company_profile_active ? 'active' : '' }}" href="{{ path('company_index') }}">
                                <span class="flex-fill">Профиль компании</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Пользователи и роли</span>
                            </a>
                            {% set report_api_key_active = macros.is_active(current_route, ['settings_report_api_key_']) %}
                            <a class="dropdown-item d-flex align-items-center justify-content-between {{ report_api_key_active ? 'active' : '' }}" href="{{ path('settings_report_api_key_index') }}">
                                <span class="flex-fill">Настройки отчётов (API-ключ)</span>
                            </a>
                            <a class="dropdown-item d-flex align-items-center justify-content-between disabled opacity-75" href="#" tabindex="-1" aria-disabled="true">
                                <span class="flex-fill">Логи и аудит</span>
                            </a>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</aside>

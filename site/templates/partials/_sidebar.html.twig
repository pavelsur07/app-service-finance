{% macro is_active(current_route, patterns) -%}
    {%- set result = false -%}
    {%- for p in patterns -%}
        {%- if p is not empty and (current_route == p or current_route starts with p) -%}
            {%- set result = true -%}
        {%- endif -%}
    {%- endfor -%}
    {{- result -}}
{%- endmacro %}

{% macro collapse_state(current_route, prefix) -%}
    {{- current_route starts with prefix ? 'show' : '' -}}
{%- endmacro %}

{% macro link_item(title, route_name, is_active, icon, dev_badge) -%}
    {%- set href = route_name ? path(route_name) : '#' -%}
    <a class="nav-link {{ is_active ? 'active' : '' }} {{ not route_name ? 'disabled opacity-75' : '' }}" href="{{ href }}">
        {%- if icon %}<span class="nav-link-icon">{{ icon|raw }}</span>{% endif -%}
        <span class="nav-link-title">{{ title }}</span>
        {%- if dev_badge %}<span class="badge bg-secondary ms-2">–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span>{% endif -%}
    </a>
{%- endmacro %}

{% import _self as macros %}

{% set current_route = app.request ? app.request.attributes.get('_route') : '' %}
{% set user_roles = [] %}
{% if app.user %}
    {% set user_roles = app.user.roles|default([]) %}
{% endif %}

<aside class="navbar navbar-vertical navbar-expand-lg" data-bs-theme="light">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ path('app_home_index') }}">–§–∏–Ω–∞–Ω—Å—ã</a>
        <div class="collapse navbar-collapse" id="sidebar-menu">
            <ul class="navbar-nav pt-lg-3">
                {% set dashboard_active = macros.is_active(current_route, ['app_home_index']) %}
                <li class="nav-item">
                    <a class="nav-link {{ dashboard_active ? '' : 'collapsed' }}" href="#sidebar-main" data-bs-toggle="collapse" role="button" aria-expanded="{{ dashboard_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üìä</span>
                        <span class="nav-link-title">–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                    <div class="collapse {{ dashboard_active ? 'show' : '' }}" id="sidebar-main">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–î–∞—à–±–æ—Ä–¥', 'app_home_index', dashboard_active, null, false) }}
                            </div>
                        </div>
                    </div>
                </li>

                {% set money_active = macros.is_active(current_route, ['cash_transaction_', 'report_account_balances', 'finance_funds_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ money_active ? '' : 'collapsed' }}" href="#sidebar-money" data-bs-toggle="collapse" role="button" aria-expanded="{{ money_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üíº</span>
                        <span class="nav-link-title">–î–µ–Ω—å–≥–∏</span>
                    </a>
                    <div class="collapse {{ money_active ? 'show' : '' }}" id="sidebar-money">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–û—Å—Ç–∞—Ç–∫–∏ –∏ —Å—á–µ—Ç–∞', 'report_account_balances_index', macros.is_active(current_route, ['report_account_balances']), null, false) }}
                            </div>
                            {% if is_funds_feature_enabled() %}
                                <div class="nav-item">
                                    {{ macros.link_item('–§–æ–Ω–¥—ã (–∫–æ–Ω–≤–µ—Ä—Ç—ã)', 'finance_funds_index', macros.is_active(current_route, ['finance_funds_']), null, false) }}
                                </div>
                            {% endif %}
                            <div class="nav-item">
                                {{ macros.link_item('–õ–µ–Ω—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π (–î–î–°-—Ñ–∞–∫—Ç)', 'cash_transaction_index', macros.is_active(current_route, ['cash_transaction_index', 'cash_transaction_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ü–µ—Ä–µ–≤–æ–¥—ã', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–°–≤–µ—Ä–∫–∞', null, false, null, true) }}
                            </div>
                        </div>
                    </div>
                </li>

                {% set documents_active = macros.is_active(current_route, ['document_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ documents_active ? '' : 'collapsed' }}" href="#sidebar-documents" data-bs-toggle="collapse" role="button" aria-expanded="{{ documents_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üìÑ</span>
                        <span class="nav-link-title">–î–æ–∫—É–º–µ–Ω—Ç—ã (–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è P&amp;L)</span>
                    </a>
                    {% set documents_show = documents_active ? 'show' : macros.collapse_state(current_route, 'document_') %}
                    <div class="collapse {{ documents_show }}" id="sidebar-documents">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–†–µ–µ—Å—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤', 'document_index', macros.is_active(current_route, ['document_index', 'document_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ü—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –≤ P&amp;L', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö', null, false, null, true) }}
                            </div>
                        </div>
                    </div>
                </li>

                {% set import_active = macros.is_active(current_route, ['cash_bank1c_import_upload', 'import_logs_', 'cash_transaction_auto_rule_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ import_active ? '' : 'collapsed' }}" href="#sidebar-import" data-bs-toggle="collapse" role="button" aria-expanded="{{ import_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">‚¨áÔ∏è</span>
                        <span class="nav-link-title">–ò–º–ø–æ—Ä—Ç</span>
                    </a>
                    {% set import_show = import_active ? 'show' : (macros.collapse_state(current_route, 'import_') ?: macros.collapse_state(current_route, 'cash_transaction_auto_rule_')) %}
                    <div class="collapse {{ import_show }}" id="sidebar-import">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–ò–º–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–∏—Å–æ–∫ (–î–î–°)', 'cash_bank1c_import_upload', macros.is_active(current_route, ['cash_bank1c_import_upload']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ñ—É—Ä–Ω–∞–ª –∏–º–ø–æ—Ä—Ç–æ–≤', 'import_logs_index', macros.is_active(current_route, ['import_logs_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ê–≤—Ç–æ–ø—Ä–∞–≤–∏–ª–∞ (–î–î–°)', 'cash_transaction_auto_rule_index', macros.is_active(current_route, ['cash_transaction_auto_rule_']), null, false) }}
                            </div>
                        </div>
                    </div>
                </li>

                {% set planning_active = macros.is_active(current_route, ['payment_calendar_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ planning_active ? '' : 'collapsed' }}" href="#sidebar-planning" data-bs-toggle="collapse" role="button" aria-expanded="{{ planning_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üìÖ</span>
                        <span class="nav-link-title">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                    </a>
                    {% set planning_show = planning_active ? 'show' : macros.collapse_state(current_route, 'payment_calendar_') %}
                    <div class="collapse {{ planning_show }}" id="sidebar-planning">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–ü–ª–∞—Ç—ë–∂–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–ø–ª–∞–Ω-—Ñ–∞–∫—Ç)', 'payment_calendar_index', macros.is_active(current_route, ['payment_calendar_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ü–ª–∞–Ω—ã –ø–ª–∞—Ç–µ–∂–µ–π', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ö—Ä–µ–¥–∏—Ç—ã –∏ –≥—Ä–∞—Ñ–∏–∫–∏', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–î–µ–ø–æ–∑–∏—Ç—ã', null, false, null, true) }}
                            </div>
                        </div>
                    </div>
                </li>

                {% set reports_active = macros.is_active(current_route, ['report_cashflow_', 'finance_report_', 'report_transactions_statement_', 'report_transactions_debug_', 'report_debug_', 'report_account_balances']) %}
                <li class="nav-item">
                    <a class="nav-link {{ reports_active ? '' : 'collapsed' }}" href="#sidebar-reports" data-bs-toggle="collapse" role="button" aria-expanded="{{ reports_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üìà</span>
                        <span class="nav-link-title">–û—Ç—á—ë—Ç—ã</span>
                    </a>
                    {% set reports_show = reports_active ? 'show' : (macros.collapse_state(current_route, 'report_') ?: macros.collapse_state(current_route, 'finance_report_')) %}
                    <div class="collapse {{ reports_show }}" id="sidebar-reports">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–î–î–° (Cash Flow)', 'report_cashflow_index', macros.is_active(current_route, ['report_cashflow_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('P&amp;L (–û–ü–∏–£)', 'finance_report_preview', macros.is_active(current_route, ['finance_report_preview']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ë–∞–ª–∞–Ω—Å –¥–µ–Ω–µ–≥', 'report_account_balances_index', macros.is_active(current_route, ['report_account_balances']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–≠–∫—Å–ø–æ—Ä—Ç', null, false, null, true) }}
                            </div>
                            {% set reports_debug_active = macros.is_active(current_route, ['report_transactions_statement_', 'report_transactions_debug_', 'report_debug_', 'finance_report_raw', 'finance_report_pl_raw']) %}
                            <div class="nav-item">
                                <a class="nav-link {{ reports_debug_active ? '' : 'collapsed' }}" href="#sidebar-reports-debug" data-bs-toggle="collapse" role="button" aria-expanded="{{ reports_debug_active ? 'true' : 'false' }}">
                                    <span class="nav-link-title">–û—Ç–ª–∞–¥–∫–∞</span>
                                </a>
                                {% set reports_debug_show = reports_debug_active ? 'show' : (macros.collapse_state(current_route, 'report_transactions_statement_') ?: macros.collapse_state(current_route, 'report_debug_') ?: macros.collapse_state(current_route, 'finance_report_raw') ?: macros.collapse_state(current_route, 'finance_report_pl_raw')) %}
                                <div class="collapse {{ reports_debug_show }}" id="sidebar-reports-debug">
                                    <div class="nav nav-pills flex-column ms-3">
                                        <div class="nav-item">
                                            {{ macros.link_item('–í—ã–ø–∏—Å–∫–∞/–°—Ç–µ–π—Ç–º–µ–Ω—Ç', 'report_transactions_statement_index', macros.is_active(current_route, ['report_transactions_statement_']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('–û—Ç—á—ë—Ç –æ—Ç–ª–∞–¥–∫–∞', 'report_transactions_debug_index', macros.is_active(current_route, ['report_transactions_debug_']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('–û—Ç—á—ë—Ç ¬´–°—ã—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏¬ª', 'report_debug_transactions_raw', macros.is_active(current_route, ['report_debug_transactions_raw']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('–û—Ç—á—ë—Ç ¬´–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–Ω–µ–≤–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏¬ª', 'report_debug_daily_facts', macros.is_active(current_route, ['report_debug_daily_facts']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('–°—ã—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –û–ü–∏–£', 'finance_report_raw', macros.is_active(current_route, ['finance_report_raw']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –û–ü–∏–£', 'finance_report_pl_raw', macros.is_active(current_route, ['finance_report_pl_raw']), null, false) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

                {% set directories_active = macros.is_active(current_route, ['cashflow_category_', 'pl_category_', 'money_account_', 'counterparty_', 'project_direction_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ directories_active ? '' : 'collapsed' }}" href="#sidebar-directories" data-bs-toggle="collapse" role="button" aria-expanded="{{ directories_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üìö</span>
                        <span class="nav-link-title">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</span>
                    </a>
                    {% set directories_show = directories_active ? 'show' : (macros.collapse_state(current_route, 'cashflow_category_') ?: macros.collapse_state(current_route, 'pl_category_') ?: macros.collapse_state(current_route, 'money_account_') ?: macros.collapse_state(current_route, 'counterparty_') ?: macros.collapse_state(current_route, 'project_direction_')) %}
                    <div class="collapse {{ directories_show }}" id="sidebar-directories">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –î–î–°', 'cashflow_category_index', macros.is_active(current_route, ['cashflow_category_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ P&amp;L', 'pl_category_index', macros.is_active(current_route, ['pl_category_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–°—á–µ—Ç–∞ / –ö–∞—Å—Å—ã / –ö–æ—à–µ–ª—å–∫–∏', 'money_account_index', macros.is_active(current_route, ['money_account_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã', 'counterparty_index', macros.is_active(current_route, ['counterparty_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ü—Ä–æ–µ–∫—Ç—ã / –¶–§–û', 'project_direction_index', macros.is_active(current_route, ['project_direction_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–¢–µ–≥–∏', null, false, null, true) }}
                            </div>
                        </div>
                    </div>
                </li>

                {% set integrations_active = macros.is_active(current_route, ['ozon_', 'wildberries_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ integrations_active ? '' : 'collapsed' }}" href="#sidebar-integrations" data-bs-toggle="collapse" role="button" aria-expanded="{{ integrations_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üîå</span>
                        <span class="nav-link-title">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</span>
                    </a>
                    {% set integrations_show = integrations_active ? 'show' : (macros.collapse_state(current_route, 'ozon_') ?: macros.collapse_state(current_route, 'wildberries_')) %}
                    <div class="collapse {{ integrations_show }}" id="sidebar-integrations">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–ú–æ–π–°–∫–ª–∞–¥', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('1–°', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ë–∞–Ω–∫–∏', null, false, null, true) }}
                            </div>
                            {% set marketplaces_active = macros.is_active(current_route, ['ozon_', 'wildberries_']) %}
                            <div class="nav-item">
                                <a class="nav-link {{ marketplaces_active ? '' : 'collapsed' }}" href="#sidebar-marketplaces" data-bs-toggle="collapse" role="button" aria-expanded="{{ marketplaces_active ? 'true' : 'false' }}">
                                    <span class="nav-link-title">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã</span>
                                </a>
                                {% set marketplaces_show = marketplaces_active ? 'show' : (macros.collapse_state(current_route, 'ozon_') ?: macros.collapse_state(current_route, 'wildberries_')) %}
                                <div class="collapse {{ marketplaces_show }}" id="sidebar-marketplaces">
                                    <div class="nav nav-pills flex-column ms-3">
                                        <div class="nav-item">
                                            {{ macros.link_item('Ozon / –ó–∞–∫–∞–∑—ã', 'ozon_orders', macros.is_active(current_route, ['ozon_order']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('Ozon / –¢–æ–≤–∞—Ä—ã', 'ozon_products', macros.is_active(current_route, ['ozon_products']), null, false) }}
                                        </div>
                                        <div class="nav-item">
                                            {{ macros.link_item('Wildberries / –ü—Ä–æ–¥–∞–∂–∏', 'wildberries_sales', macros.is_active(current_route, ['wildberries_sales']), null, false) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

                {% set company_active = macros.is_active(current_route, ['company_', 'settings_report_api_key_']) %}
                <li class="nav-item">
                    <a class="nav-link {{ company_active ? '' : 'collapsed' }}" href="#sidebar-company" data-bs-toggle="collapse" role="button" aria-expanded="{{ company_active ? 'true' : 'false' }}">
                        <span class="nav-link-icon">üè¢</span>
                        <span class="nav-link-title">–ö–æ–º–ø–∞–Ω–∏—è –∏ –¥–æ—Å—Ç—É–ø</span>
                    </a>
                    {% set company_show = company_active ? 'show' : (macros.collapse_state(current_route, 'company_') ?: macros.collapse_state(current_route, 'settings_report_api_key_')) %}
                    <div class="collapse {{ company_show }}" id="sidebar-company">
                        <div class="nav nav-pills flex-column">
                            <div class="nav-item">
                                {{ macros.link_item('–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏', 'company_index', macros.is_active(current_route, ['company_index', 'company_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Ä–æ–ª–∏', null, false, null, true) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á—ë—Ç–æ–≤ (API-–∫–ª—é—á)', 'settings_report_api_key_index', macros.is_active(current_route, ['settings_report_api_key_']), null, false) }}
                            </div>
                            <div class="nav-item">
                                {{ macros.link_item('–õ–æ–≥–∏ –∏ –∞—É–¥–∏—Ç', null, false, null, true) }}
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</aside>

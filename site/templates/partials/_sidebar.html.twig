{% macro is_active(current_route, patterns) -%}
    {%- set result = false -%}
    {%- for p in patterns -%}
        {%- if p is not empty and (current_route == p or current_route starts with p) -%}
            {%- set result = true -%}
        {%- endif -%}
    {%- endfor -%}
    {{- result -}}
{%- endmacro %}

{% macro collapse_state(current_route, prefix) -%}
    {{- current_route starts with prefix ? 'show' : '' -}}
{%- endmacro %}

{% macro dropdown_item(title, route_name, is_active, dev_badge) -%}
    {%- set href = route_name ? path(route_name) : '#' -%}
    {%- set disabled = route_name is empty -%}
    <a class="dropdown-item d-flex align-items-center justify-content-between {{ is_active ? 'active' : '' }} {{ disabled ? 'disabled opacity-75' : '' }}" href="{{ href }}" {% if disabled %}tabindex="-1" aria-disabled="true"{% endif %}>
        <span class="flex-fill">{{ title }}</span>
    </a>
{%- endmacro %}

{% import _self as macros %}

{% set current_route = app.request ? app.request.attributes.get('_route') : '' %}
{% set user_roles = [] %}
{% if app.user %}
    {% set user_roles = app.user.roles|default([]) %}
{% endif %}

<aside class="navbar navbar-vertical navbar-expand-lg navbar-transparent" data-bs-theme="light">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar-menu" aria-controls="sidebar-menu" aria-expanded="false" aria-label="Переключить навигацию">
            <span class="navbar-toggler-icon"></span>
        </button>
        <h1 class="navbar-brand navbar-brand-autodark">
            <a href="{{ path('app_home_index') }}">Финансы</a>
        </h1>
        <div class="collapse navbar-collapse" id="sidebar-menu">
            <ul class="navbar-nav pt-lg-3">
                {% set dashboard_active = macros.is_active(current_route, ['app_home_index']) %}
                <li class="nav-item">
                    <a class="nav-link {{ dashboard_active ? 'active' : '' }}" href="{{ path('app_home_index') }}">
                        <span class="nav-link-title">Главная</span>
                    </a>
                </li>

                {% set money_active = macros.is_active(current_route, ['cash_transaction_', 'report_account_balances', 'finance_funds_']) %}
                <li class="nav-item dropdown {{ money_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ money_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ money_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Деньги</span>
                    </a>
                    <div class="dropdown-menu {{ money_active ? 'show' : '' }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('Операций ДДС', 'cash_transaction_index', macros.is_active(current_route, ['cash_transaction_index', 'cash_transaction_']), false) }}
                            {{ macros.dropdown_item('Остатки и счета', 'report_account_balances_index', macros.is_active(current_route, ['report_account_balances']), false) }}
                            {% if is_funds_feature_enabled() %}
                                {{ macros.dropdown_item('Фонды (конверты)', 'finance_funds_index', macros.is_active(current_route, ['finance_funds_']), false) }}
                            {% endif %}
                            {{ macros.dropdown_item('Переводы', null, false, true) }}
                            {{ macros.dropdown_item('Сверка', null, false, true) }}
                        </div>
                    </div>
                </li>

                {% set documents_active = macros.is_active(current_route, ['document_']) %}
                <li class="nav-item dropdown {{ documents_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ documents_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ documents_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Документы ОПиУ</span>
                    </a>
                    {% set documents_show = documents_active ? 'show' : macros.collapse_state(current_route, 'document_') %}
                    <div class="dropdown-menu {{ documents_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('Реестр документов', 'document_index', macros.is_active(current_route, ['document_index', 'document_']), false) }}
                            {{ macros.dropdown_item('Карточка документа', null, false, true) }}
                            {{ macros.dropdown_item('Правила маппинга ОПиУ', null, false, true) }}
                            {{ macros.dropdown_item('Качество данных', null, false, true) }}
                        </div>
                    </div>
                </li>

                {% set import_active = macros.is_active(current_route, ['cash_bank1c_import_upload', 'import_logs_', 'cash_transaction_auto_rule_']) %}
                <li class="nav-item dropdown {{ import_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ import_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ import_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Импорт</span>
                    </a>
                    {% set import_show = import_active ? 'show' : (macros.collapse_state(current_route, 'import_') ?: macros.collapse_state(current_route, 'cash_transaction_auto_rule_')) %}
                    <div class="dropdown-menu {{ import_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('Импорт документов', null, false, true) }}
                            {{ macros.dropdown_item('Импорт выписок 1C', 'cash_bank1c_import_upload', macros.is_active(current_route, ['cash_bank1c_import_upload']), false) }}
                            {{ macros.dropdown_item('Журнал импортов', 'import_logs_index', macros.is_active(current_route, ['import_logs_']), false) }}
                            {{ macros.dropdown_item('Автоправила ДДС', 'cash_transaction_auto_rule_index', macros.is_active(current_route, ['cash_transaction_auto_rule_']), false) }}
                        </div>
                    </div>
                </li>

                {% set planning_active = macros.is_active(current_route, ['payment_calendar_']) %}
                <li class="nav-item dropdown {{ planning_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ planning_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ planning_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Планирование</span>
                    </a>
                    {% set planning_show = planning_active ? 'show' : macros.collapse_state(current_route, 'payment_calendar_') %}
                    <div class="dropdown-menu {{ planning_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('Платёжный календарь', 'payment_calendar_index', macros.is_active(current_route, ['payment_calendar_']), false) }}
                            {{ macros.dropdown_item('Планы платежей', null, false, true) }}
                            {{ macros.dropdown_item('Кредиты и графики', null, false, true) }}
                            {{ macros.dropdown_item('Депозиты', null, false, true) }}
                        </div>
                    </div>
                </li>

                {% set reports_active = macros.is_active(current_route, ['report_cashflow_', 'finance_report_', 'report_transactions_statement_', 'report_transactions_debug_', 'report_debug_', 'report_account_balances']) %}
                <li class="nav-item dropdown {{ reports_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ reports_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ reports_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Отчёты</span>
                    </a>
                    {% set reports_show = reports_active ? 'show' : (macros.collapse_state(current_route, 'report_') ?: macros.collapse_state(current_route, 'finance_report_')) %}
                    <div class="dropdown-menu {{ reports_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('ДДС (Cash Flow)', 'report_cashflow_index', macros.is_active(current_route, ['report_cashflow_']), false) }}
                            {{ macros.dropdown_item('ОПиУ (PnL)', 'finance_report_preview', macros.is_active(current_route, ['finance_report_preview']), false) }}
                            {{ macros.dropdown_item('Упрощённый баланс', null, false, true) }}
                            {{ macros.dropdown_item('Экспорт', null, false, true) }}
                            {% set reports_debug_active = macros.is_active(current_route, ['report_transactions_statement_', 'report_transactions_debug_', 'report_debug_', 'finance_report_raw', 'finance_report_pl_raw']) %}
                            <div class="dropend {{ reports_debug_active ? 'show' : '' }}">
                                <a class="dropdown-item dropdown-toggle d-flex align-items-center justify-content-between {{ reports_debug_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ reports_debug_active ? 'true' : 'false' }}">
                                    <span class="flex-fill">Отладка</span>
                                </a>
                                {% set reports_debug_show = reports_debug_active ? 'show' : (macros.collapse_state(current_route, 'report_transactions_statement_') ?: macros.collapse_state(current_route, 'report_debug_') ?: macros.collapse_state(current_route, 'finance_report_raw') ?: macros.collapse_state(current_route, 'finance_report_pl_raw')) %}
                                <div class="dropdown-menu {{ reports_debug_show }}">
                                    {{ macros.dropdown_item('Выписка/Стейтмент', 'report_transactions_statement_index', macros.is_active(current_route, ['report_transactions_statement_']), false) }}
                                    {{ macros.dropdown_item('Отчёт отладка', 'report_transactions_debug_index', macros.is_active(current_route, ['report_transactions_debug_']), false) }}
                                    {{ macros.dropdown_item('Отчёт «Сырые транзакции»', 'report_debug_transactions_raw', macros.is_active(current_route, ['report_debug_transactions_raw']), false) }}
                                    {{ macros.dropdown_item('Отчёт «Фактические дневные остатки»', 'report_debug_daily_facts', macros.is_active(current_route, ['report_debug_daily_facts']), false) }}
                                    {{ macros.dropdown_item('Сырые транзакции ОПиУ', 'finance_report_raw', macros.is_active(current_route, ['finance_report_raw']), false) }}
                                    {{ macros.dropdown_item('Сырые данные ОПиУ', 'finance_report_pl_raw', macros.is_active(current_route, ['finance_report_pl_raw']), false) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

                {% set directories_active = macros.is_active(current_route, ['cashflow_category_', 'pl_category_', 'money_account_', 'counterparty_', 'project_direction_']) %}
                <li class="nav-item dropdown {{ directories_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ directories_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ directories_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Справочники</span>
                    </a>
                    {% set directories_show = directories_active ? 'show' : (macros.collapse_state(current_route, 'cashflow_category_') ?: macros.collapse_state(current_route, 'pl_category_') ?: macros.collapse_state(current_route, 'money_account_') ?: macros.collapse_state(current_route, 'counterparty_') ?: macros.collapse_state(current_route, 'project_direction_')) %}
                    <div class="dropdown-menu {{ directories_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('Категории ДДС', 'cashflow_category_index', macros.is_active(current_route, ['cashflow_category_']), false) }}
                            {{ macros.dropdown_item('Категории ОПиУ', 'pl_category_index', macros.is_active(current_route, ['pl_category_']), false) }}
                            {{ macros.dropdown_item('Счета / Кассы / Кошельки', 'money_account_index', macros.is_active(current_route, ['money_account_']), false) }}
                            {{ macros.dropdown_item('Контрагенты', 'counterparty_index', macros.is_active(current_route, ['counterparty_']), false) }}
                            {{ macros.dropdown_item('Проекты / ЦФО', 'project_direction_index', macros.is_active(current_route, ['project_direction_']), false) }}
                            {{ macros.dropdown_item('Теги', null, false, true) }}
                        </div>
                    </div>
                </li>

                {% set integrations_active = macros.is_active(current_route, ['ozon_', 'wildberries_']) %}
                <li class="nav-item dropdown {{ integrations_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ integrations_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ integrations_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Интеграции</span>
                    </a>
                    {% set integrations_show = integrations_active ? 'show' : (macros.collapse_state(current_route, 'ozon_') ?: macros.collapse_state(current_route, 'wildberries_')) %}
                    <div class="dropdown-menu {{ integrations_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('МойСклад', null, false, true) }}
                            {{ macros.dropdown_item('1С', null, false, true) }}
                            {{ macros.dropdown_item('Банки', null, false, true) }}
                            {% set marketplaces_active = macros.is_active(current_route, ['ozon_', 'wildberries_']) %}
                            <div class="dropend {{ marketplaces_active ? 'show' : '' }}">
                                <a class="dropdown-item dropdown-toggle d-flex align-items-center justify-content-between {{ marketplaces_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ marketplaces_active ? 'true' : 'false' }}">
                                    <span class="flex-fill">Маркетплейсы</span>
                                </a>
                                {% set marketplaces_show = marketplaces_active ? 'show' : (macros.collapse_state(current_route, 'ozon_') ?: macros.collapse_state(current_route, 'wildberries_')) %}
                                <div class="dropdown-menu {{ marketplaces_show }}">
                                    {{ macros.dropdown_item('Ozon / Заказы', 'ozon_orders', macros.is_active(current_route, ['ozon_order']), false) }}
                                    {{ macros.dropdown_item('Ozon / Товары', 'ozon_products', macros.is_active(current_route, ['ozon_products']), false) }}
                                    {{ macros.dropdown_item('Wildberries / Продажи', 'wildberries_sales', macros.is_active(current_route, ['wildberries_sales']), false) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </li>

                {% set company_active = macros.is_active(current_route, ['company_', 'settings_report_api_key_']) %}
                <li class="nav-item dropdown {{ company_active ? 'show' : '' }}">
                    <a class="nav-link dropdown-toggle {{ company_active ? 'show active' : '' }}" href="#" data-bs-toggle="dropdown" data-bs-auto-close="false" role="button" aria-expanded="{{ company_active ? 'true' : 'false' }}">
                        <span class="nav-link-title">Компания и доступ</span>
                    </a>
                    {% set company_show = company_active ? 'show' : (macros.collapse_state(current_route, 'company_') ?: macros.collapse_state(current_route, 'settings_report_api_key_')) %}
                    <div class="dropdown-menu {{ company_show }}">
                        <div class="dropdown-menu-column">
                            {{ macros.dropdown_item('Профиль компании', 'company_index', macros.is_active(current_route, ['company_index', 'company_']), false) }}
                            {{ macros.dropdown_item('Пользователи и роли', null, false, true) }}
                            {{ macros.dropdown_item('Настройки отчётов (API-ключ)', 'settings_report_api_key_index', macros.is_active(current_route, ['settings_report_api_key_']), false) }}
                            {{ macros.dropdown_item('Логи и аудит', null, false, true) }}
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</aside>

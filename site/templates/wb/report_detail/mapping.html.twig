{% extends 'base.html.twig' %}

{% block title %}Детализация Wildberries — маппинг и ОПиУ{% endblock %}

{% block body %}
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1 class="mb-0">Детализация Wildberries — маппинг и ОПиУ</h1>
    </div>

    {% include 'wb/report_detail/_tabs.html.twig' %}

    <form method="get" class="row g-3 mb-4">
        <div class="col-sm-6 col-md-4 col-lg-3">
            <label for="filter-from" class="form-label">Период с</label>
            <input id="filter-from" type="date" name="from" value="{{ from|date('Y-m-d') }}" class="form-control">
        </div>
        <div class="col-sm-6 col-md-4 col-lg-3">
            <label for="filter-to" class="form-label">Период по</label>
            <input id="filter-to" type="date" name="to" value="{{ to|date('Y-m-d') }}" class="form-control">
        </div>
        <div class="col-12 d-flex justify-content-end align-items-end gap-2">
            <a href="{{ path('wb_report_detail_mapping_index') }}" class="btn btn-outline-secondary">Последняя неделя</a>
            <button type="submit" class="btn btn-primary">Показать</button>
        </div>
    </form>

    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <h2 class="card-title mb-0">Маппинг операций</h2>
                    <div class="text-muted">Всего комбинаций: {{ items|length }}</div>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <label for="wb-mapping-sort" class="form-label mb-0">Сортировка:</label>
                    <select id="wb-mapping-sort" class="form-select form-select-sm w-auto">
                        <option value="order">Как получено</option>
                        <option value="doc">По типу документа</option>
                        <option value="supplier">По обоснованию</option>
                        <option value="rows">По количеству строк</option>
                        <option value="note" selected>По примечанию</option>
                        <option value="category">По PL категории</option>
                        <option value="active">Активные сверху</option>
                    </select>
                </div>
            </div>

            <form id="wb-report-mapping-form" method="post" action="{{ path('wb_report_detail_mapping_save', { from: from|date('Y-m-d'), to: to|date('Y-m-d') }) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('wb_report_detail_mapping') }}">
                <input type="hidden" name="from" value="{{ from|date('Y-m-d') }}">
                <input type="hidden" name="to" value="{{ to|date('Y-m-d') }}">
                <div id="wb-mapping-deleted" class="d-none"></div>

                <div class="table-responsive mb-3">
                    <table class="table table-striped align-middle">
                        <thead>
                        <tr>
                            <th>Примечание</th>
                            <th>Тип документа</th>
                            <th>Обоснование</th>
                            <th class="text-end">Строк</th>
                            <th>Поле суммы</th>
                            <th>Знак (+/−)</th>
                            <th>PL категория</th>
                            <th class="text-center">Активен</th>
                            <th class="text-center">Действия</th>
                        </tr>
                        </thead>
                        <tbody id="wb-mapping-table-body">
                        {% for item in items %}
                            {% set mapping = item.mapping ?? null %}
                            {% set selectedSourceField = mapping ? mapping.sourceField : '' %}
                            {% set selectedSign = mapping ? mapping.signMultiplier : 1 %}
                            {% set selectedCategory = mapping and mapping.plCategory ? mapping.plCategory : null %}
                            {% set selectedCategoryLabel = selectedCategory ? (selectedCategory.label ?? selectedCategory.name ?? 'Не выбрано') : 'Не выбрано' %}
                            {% set isActive = mapping is null or mapping.isActive %}
                            <tr class="js-wb-mapping-row"
                                data-original-order="{{ loop.index0 }}"
                                data-doc-type="{{ item.docTypeName ?? '—' }}"
                                data-supplier="{{ item.supplierOperName ?? '—' }}"
                                data-rows="{{ item.rowsCount }}">
                                <td>
                                    <div class="js-wb-note-text">{{ mapping ? mapping.note : '—' }}</div>
                                    <input type="hidden"
                                           name="mappings[{{ loop.index0 }}][note]"
                                           value="{{ mapping ? mapping.note : '' }}"
                                           class="js-wb-note-input">
                                </td>
                                <td>
                                    <div class="js-wb-doc-type">{{ item.docTypeName ?? '—' }}</div>
                                    <input type="hidden" name="mappings[{{ loop.index0 }}][docTypeName]" value="{{ item.docTypeName }}">
                                </td>
                                <td>
                                    <div class="fw-semibold js-wb-supplier">{{ item.supplierOperName ?? '—' }}</div>
                                    <input type="hidden" name="mappings[{{ loop.index0 }}][supplierOperName]" value="{{ item.supplierOperName }}">
                                    {% if mapping %}
                                        <input type="hidden" name="mappings[{{ loop.index0 }}][id]" value="{{ mapping.id }}">
                                    {% endif %}
                                </td>
                                <td class="text-end js-wb-rows">{{ item.rowsCount }}</td>
                                <td>
                                    <div class="js-wb-source-field-text">{{ selectedSourceField ?: '—' }}</div>
                                    <input type="hidden"
                                           name="mappings[{{ loop.index0 }}][sourceField]"
                                           value="{{ selectedSourceField }}"
                                           class="js-wb-source-field-input">
                                </td>
                                <td>
                                    <div class="js-wb-sign-text">{{ selectedSign == -1 ? '−' : '+' }}</div>
                                    <input type="hidden"
                                           name="mappings[{{ loop.index0 }}][signMultiplier]"
                                           value="{{ selectedSign }}"
                                           class="js-wb-sign-input">
                                </td>
                                <td>
                                    <div class="js-wb-category-text">{{ selectedCategoryLabel }}</div>
                                    <input type="hidden"
                                           name="mappings[{{ loop.index0 }}][plCategoryId]"
                                           value="{{ selectedCategory ? selectedCategory.id : '' }}"
                                           class="js-wb-category-input">
                                </td>
                                <td class="text-center">
                                    <div class="js-wb-active-state badge {{ isActive ? 'bg-success' : 'bg-secondary' }}">
                                        {{ isActive ? 'Активен' : 'Выключен' }}
                                    </div>
                                    <input type="hidden"
                                           name="mappings[{{ loop.index0 }}][isActive]"
                                           value="{{ isActive ? 1 : 0 }}"
                                           class="js-wb-active-input">
                                </td>
                                <td class="text-center">
                                    <div class="dropdown position-static {{ loop.last ? 'dropup' : '' }}">
                                        <button class="btn btn-link p-0 text-muted" data-bs-toggle="dropdown" aria-label="Действия">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="5" cy="12" r="1"/>
                                                <circle cx="12" cy="12" r="1"/>
                                                <circle cx="19" cy="12" r="1"/>
                                            </svg>
                                        </button>

                                        <div class="dropdown-menu dropdown-menu-end shadow-sm">
                                            <button type="button" class="dropdown-item js-wb-mapping-edit">
                                                <i class="ti ti-pencil me-2"></i> Редактировать
                                            </button>
                                            <button type="button" class="dropdown-item js-wb-mapping-copy">
                                                <i class="ti ti-copy me-2"></i> Копировать
                                            </button>
                                            <div class="dropdown-divider"></div>
                                            <button type="button" class="dropdown-item text-danger js-wb-mapping-delete">
                                                <i class="ti ti-trash me-2"></i> Удалить
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="9" class="text-center">Комбинации не найдены</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

            </form>
            <div class="d-flex justify-content-end gap-2 flex-wrap">
                <form method="post"
                      action="{{ path('wb_report_detail_mapping_clear') }}"
                      class="js-wb-mapping-clear-form">
                    <input type="hidden" name="_token" value="{{ csrf_token('wb_report_detail_mapping_clear') }}">
                    <input type="hidden" name="from" value="{{ from|date('Y-m-d') }}">
                    <input type="hidden" name="to" value="{{ to|date('Y-m-d') }}">
                    <button type="submit" class="btn btn-outline-danger">- Очистить</button>
                </form>
                <button type="submit" form="wb-report-mapping-form" class="btn btn-primary">Сохранить маппинг</button>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="wb-mapping-editor" aria-labelledby="wb-mapping-editor-label">
        <div class="offcanvas-header">
            <div>
                <div class="text-muted small">Тип документа</div>
                <h5 class="offcanvas-title mb-0" id="wb-mapping-editor-label">—</h5>
                <div class="text-muted" id="wb-mapping-supplier">—</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
        </div>
        <div class="offcanvas-body">
            <div class="mb-3">
                <label for="wb-mapping-note" class="form-label">Примечание</label>
                <input type="text" id="wb-mapping-note" class="form-control" maxlength="1024" placeholder="Комментарий к правилу">
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="wb-mapping-source-field" class="form-label">Поле суммы</label>
                    <select id="wb-mapping-source-field" class="form-select">
                        <option value="">—</option>
                        {% for option in sourceFieldOptions %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="wb-mapping-sign" class="form-label">Знак (+/−)</label>
                    <select id="wb-mapping-sign" class="form-select">
                        <option value="1">+</option>
                        <option value="-1">−</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="wb-mapping-category" class="form-label">PL категория</label>
                <select id="wb-mapping-category" class="form-select">
                    <option value="">Не выбрано</option>
                    {% for category in categoryOptions %}
                        <option value="{{ category.id }}">{{ category.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="wb-mapping-active" checked>
                <label class="form-check-label" for="wb-mapping-active">Активно</label>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Отмена</button>
                <button type="button" class="btn btn-primary" id="wb-mapping-save">Сохранить</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <h2 class="card-title mb-0">Недельный отчёт / Документ ОПиУ</h2>
                <form method="post" action="{{ path('wb_report_detail_mapping_create_document') }}" class="d-flex gap-2 align-items-end flex-wrap">
                    <input type="hidden" name="_token" value="{{ csrf_token('wb_report_detail_mapping_create_document') }}">
                    <input type="hidden" name="from" value="{{ from|date('Y-m-d') }}">
                    <input type="hidden" name="to" value="{{ to|date('Y-m-d') }}">
                    <button type="submit" class="btn btn-success">Создать документ</button>
                </form>
            </div>

            <div class="table-responsive mb-3">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th>PL категория</th>
                        <th class="text-end">Сумма</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for categoryId, amount in totals %}
                        {% set category = categoryById[categoryId] ?? null %}
                        <tr>
                            <td>{{ category ? category.name : categoryId }}</td>
                            <td class="text-end">{{ amount|number_format(2, '.', ' ') }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="2" class="text-center">Нет данных для выбранного периода</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if unmapped is not empty %}
                <div class="alert alert-warning mb-0">
                    <div class="fw-semibold mb-2">Немапнутые комбинации — сначала закрой их в маппинге:</div>
                    <div class="table-responsive mb-2">
                        <table class="table table-sm mb-0">
                            <thead>
                            <tr>
                                <th>Тип документа</th>
                                <th>Обоснование</th>
                                <th class="text-end">Строк</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for item in unmapped %}
                                <tr>
                                    <td>{{ item.docTypeName ?? '—' }}</td>
                                    <td>{{ item.supplierOperName ?? '—' }}</td>
                                    <td class="text-end">{{ item.rowsCount }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-0">После маппинга всех комбинаций станет доступно создание документа.</div>
                </div>
            {% endif %}
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Подтверждение очистки маппинга
            document.addEventListener('submit', function (event) {
                const clearForm = event.target.closest('.js-wb-mapping-clear-form');

                if (!clearForm) {
                    return;
                }

                if (!confirm('Очистить все сохранённые правила маппинга?')) {
                    event.preventDefault();
                }
            });

            const mappingTableBody = document.getElementById('wb-mapping-table-body');
            const sortSelect = document.getElementById('wb-mapping-sort');

            const offcanvasElement = document.getElementById('wb-mapping-editor');
            const offcanvas = offcanvasElement ? new bootstrap.Offcanvas(offcanvasElement) : null;
            const docTypeTarget = document.getElementById('wb-mapping-editor-label');
            const supplierTarget = document.getElementById('wb-mapping-supplier');
            const noteInput = document.getElementById('wb-mapping-note');
            const sourceFieldSelect = document.getElementById('wb-mapping-source-field');
            const signSelect = document.getElementById('wb-mapping-sign');
            const categorySelect = document.getElementById('wb-mapping-category');
            const activeCheckbox = document.getElementById('wb-mapping-active');
            const saveButton = document.getElementById('wb-mapping-save');
            const deletedContainer = document.getElementById('wb-mapping-deleted');

            let currentRow = null;

            // Общая переиндексация полей для корректной отправки формы
            function reindexRows(tbody) {
                const rows = tbody.querySelectorAll('.js-wb-mapping-row');
                rows.forEach(function (tr, index) {
                    if (!tr.dataset.originalOrder) {
                        tr.dataset.originalOrder = String(index);
                    }

                    const inputs = tr.querySelectorAll('input[name^="mappings["], select[name^="mappings["]');
                    inputs.forEach(function (input) {
                        input.name = input.name.replace(/mappings\[\d+]/, 'mappings[' + index + ']');
                    });
                });
            }

            // Обновляем бейдж статуса активности
            function updateActiveBadge(row, isActive) {
                const badge = row.querySelector('.js-wb-active-state');
                if (!badge) {
                    return;
                }

                badge.textContent = isActive ? 'Активен' : 'Выключен';
                badge.classList.toggle('bg-success', isActive);
                badge.classList.toggle('bg-secondary', !isActive);
            }

            // Заполняем оффканвас данными строки
            function fillEditorFromRow(row) {
                const noteValue = row.querySelector('.js-wb-note-input')?.value || '';
                const sourceFieldValue = row.querySelector('.js-wb-source-field-input')?.value || '';
                const signValue = row.querySelector('.js-wb-sign-input')?.value || '1';
                const categoryValue = row.querySelector('.js-wb-category-input')?.value || '';
                const isActiveValue = row.querySelector('.js-wb-active-input')?.value || '1';

                docTypeTarget.textContent = row.dataset.docType || '—';
                supplierTarget.textContent = row.dataset.supplier || '—';
                noteInput.value = noteValue;
                sourceFieldSelect.value = sourceFieldValue;
                signSelect.value = signValue;
                categorySelect.value = categoryValue;
                activeCheckbox.checked = isActiveValue === '1';
            }

            // Применяем изменения из модального окна к строке таблицы
            function applyEditorToRow() {
                if (!currentRow) {
                    return;
                }

                const noteValue = noteInput.value.trim();
                const sourceFieldValue = sourceFieldSelect.value;
                const signValue = signSelect.value === '-1' ? '-1' : '1';
                const categoryValue = categorySelect.value;
                const categoryLabel = categorySelect.options[categorySelect.selectedIndex]?.textContent || 'Не выбрано';
                const isActiveValue = activeCheckbox.checked ? '1' : '0';

                const noteTarget = currentRow.querySelector('.js-wb-note-text');
                if (noteTarget) {
                    noteTarget.textContent = noteValue || '—';
                }
                const noteInputField = currentRow.querySelector('.js-wb-note-input');
                if (noteInputField) {
                    noteInputField.value = noteValue;
                }

                const sourceFieldTarget = currentRow.querySelector('.js-wb-source-field-text');
                if (sourceFieldTarget) {
                    sourceFieldTarget.textContent = sourceFieldValue || '—';
                }
                const sourceFieldInput = currentRow.querySelector('.js-wb-source-field-input');
                if (sourceFieldInput) {
                    sourceFieldInput.value = sourceFieldValue;
                }

                const signTarget = currentRow.querySelector('.js-wb-sign-text');
                if (signTarget) {
                    signTarget.textContent = signValue === '-1' ? '−' : '+';
                }
                const signInput = currentRow.querySelector('.js-wb-sign-input');
                if (signInput) {
                    signInput.value = signValue;
                }

                const categoryTarget = currentRow.querySelector('.js-wb-category-text');
                if (categoryTarget) {
                    categoryTarget.textContent = categoryLabel;
                }
                const categoryInputField = currentRow.querySelector('.js-wb-category-input');
                if (categoryInputField) {
                    categoryInputField.value = categoryValue;
                }

                const activeInput = currentRow.querySelector('.js-wb-active-input');
                if (activeInput) {
                    activeInput.value = isActiveValue;
                }
                updateActiveBadge(currentRow, isActiveValue === '1');

                offcanvas?.hide();
            }

            // Сортировка строк маппинга
            function sortRows(sortType) {
                if (!mappingTableBody) {
                    return;
                }

                const rows = Array.from(mappingTableBody.querySelectorAll('.js-wb-mapping-row'));
                rows.sort(function (a, b) {
                    const getText = function (row, selector, fallback = '') {
                        const element = row.querySelector(selector);
                        return element ? element.textContent.trim() : fallback;
                    };

                    const getNumber = function (row, selector, fallback = 0) {
                        const textValue = getText(row, selector, String(fallback));
                        const numberValue = Number(textValue.replace(/[^\d.-]/g, ''));
                        return Number.isFinite(numberValue) ? numberValue : fallback;
                    };

                    const getBooleanFlag = function (row) {
                        const value = row.querySelector('.js-wb-active-input')?.value;
                        return value === '1';
                    };

                    switch (sortType) {
                        case 'doc':
                            return getText(a, '.js-wb-doc-type').localeCompare(getText(b, '.js-wb-doc-type'))
                                || getText(a, '.js-wb-supplier').localeCompare(getText(b, '.js-wb-supplier'));
                        case 'supplier':
                            return getText(a, '.js-wb-supplier').localeCompare(getText(b, '.js-wb-supplier'))
                                || getText(a, '.js-wb-doc-type').localeCompare(getText(b, '.js-wb-doc-type'));
                        case 'rows':
                            return getNumber(b, '.js-wb-rows', 0) - getNumber(a, '.js-wb-rows', 0);
                        case 'note':
                            return getText(a, '.js-wb-note-text').localeCompare(getText(b, '.js-wb-note-text'))
                                || Number(a.dataset.originalOrder) - Number(b.dataset.originalOrder);
                        case 'category':
                            return getText(a, '.js-wb-category-text').localeCompare(getText(b, '.js-wb-category-text'))
                                || Number(a.dataset.originalOrder) - Number(b.dataset.originalOrder);
                        case 'active':
                            return Number(getBooleanFlag(b)) - Number(getBooleanFlag(a))
                                || Number(a.dataset.originalOrder) - Number(b.dataset.originalOrder);
                        default:
                            return Number(a.dataset.originalOrder) - Number(b.dataset.originalOrder);
                    }
                });

                rows.forEach(function (row) {
                    mappingTableBody.appendChild(row);
                });
            }

            sortSelect?.addEventListener('change', function () {
                sortRows(this.value);
            });

            if (sortSelect) {
                sortRows(sortSelect.value);
            }

            // Копирование строки маппинга
            document.addEventListener('click', function (event) {
                const copyButton = event.target.closest('.js-wb-mapping-copy');
                if (!copyButton) {
                    return;
                }

                event.preventDefault();

                const row = copyButton.closest('.js-wb-mapping-row');
                if (!row) {
                    return;
                }

                const tbody = row.closest('tbody');
                if (!tbody) {
                    return;
                }

                // Клонируем строку и переносим только видимые значения
                const clone = row.cloneNode(true);

                // Сбрасываем выбранную PL-категорию в копии, чтобы её явно выбрать
                const categoryInput = clone.querySelector('.js-wb-category-input');
                if (categoryInput) {
                    categoryInput.value = '';
                }
                const categoryText = clone.querySelector('.js-wb-category-text');
                if (categoryText) {
                    categoryText.textContent = 'Не выбрано';
                }

                // Удаляем id существующего маппинга в копии, чтобы создать новое правило
                const mappingIdInput = clone.querySelector('input[name*="[id]"]');
                if (mappingIdInput) {
                    mappingIdInput.value = '';
                }

                // Обновляем порядковый номер для сортировки "как получено"
                clone.dataset.originalOrder = tbody.querySelectorAll('.js-wb-mapping-row').length;

                // Вставляем клон сразу под исходной строкой
                row.insertAdjacentElement('afterend', clone);

                // Переиндексируем имена полей после копирования
                reindexRows(tbody);
            });

            // Удаление строки маппинга
            document.addEventListener('click', function (event) {
                const deleteButton = event.target.closest('.js-wb-mapping-delete');
                if (!deleteButton) {
                    return;
                }

                const row = deleteButton.closest('.js-wb-mapping-row');
                const tbody = row?.closest('tbody');

                if (!row || !tbody) {
                    return;
                }

                const mappingIdInput = row.querySelector('input[name*="[id]"]');

                if (mappingIdInput && mappingIdInput.value && deletedContainer) {
                    const deletedInput = document.createElement('input');
                    deletedInput.type = 'hidden';
                    deletedInput.name = 'deletedMappings[]';
                    deletedInput.value = mappingIdInput.value;
                    deletedContainer.appendChild(deletedInput);
                }

                // Закрываем оффканвас, если удаляем редактируемую строку
                if (currentRow === row) {
                    currentRow = null;
                    offcanvas?.hide();
                }

                row.remove();
                reindexRows(tbody);
            });

            // Открываем редактор для выбранной строки
            document.addEventListener('click', function (event) {
                const editButton = event.target.closest('.js-wb-mapping-edit');
                if (!editButton) {
                    return;
                }

                currentRow = editButton.closest('.js-wb-mapping-row');
                if (!currentRow) {
                    return;
                }

                fillEditorFromRow(currentRow);
                offcanvas?.show();
            });

            // Сохраняем значения из оффканваса
            saveButton?.addEventListener('click', applyEditorToRow);
        });
    </script>
{% endblock %}

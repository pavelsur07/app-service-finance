{% extends 'marketplace/layout.html.twig' %}

{% block tab_content %}
    <div class="container-xl py-4">
        {% if unmapped_count == 0 %}
            <div class="empty">
                <div class="empty-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M5 12l5 5l10 -10"></path>
                    </svg>
                </div>
                <p class="empty-title">Все листинги привязаны!</p>
                <p class="empty-subtitle text-muted">
                    У вас нет листингов без привязки к продуктам.
                </p>
                <div class="empty-action">
                    <a href="{{ path('marketplace_products_index') }}" class="btn btn-primary">
                        Перейти к листингам
                    </a>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ unmapped_count }} листингов без привязки</h3>
                    <div class="card-actions">
                        <div class="input-icon">
                            <input type="text" class="form-control" placeholder="Поиск..." id="search-input">
                            <span class="input-icon-addon">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                    <circle cx="10" cy="10" r="7"></circle>
                                    <line x1="21" y1="21" x2="15" y2="15"></line>
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table card-table table-vcenter text-nowrap">
                        <thead>
                        <tr>
                            <th>Маркетплейс</th>
                            <th>Marketplace SKU</th>
                            <th>Supplier SKU</th>
                            <th>Размер</th>
                            <th>Цена</th>
                            <th>Создан</th>
                            <th class="w-1">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for listing in listings %}
                            <tr>
                                <td>
                                    <span class="badge bg-azure-lt">{{ listing.marketplace|upper }}</span>
                                </td>
                                <td>
                                    <strong>{{ listing.marketplace_sku }}</strong>
                                </td>
                                <td>
                                    {% if listing.supplier_sku %}
                                        <code>{{ listing.supplier_sku }}</code>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>{{ listing.size }}</td>
                                <td>{{ listing.price }} ₽</td>
                                <td>
                                    <span class="text-muted">{{ listing.created_at|date('d.m.Y H:i') }}</span>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm map-listing-btn"
                                            data-listing-id="{{ listing.id }}"
                                            data-listing-sku="{{ listing.marketplace_sku }}">
                                        Привязать
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block modals %}
    <div class="modal modal-blur fade" id="mapListingModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Привязать листинг к продукту</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Листинг</label>
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-auto">
                                        <span class="badge bg-azure-lt">WB</span>
                                    </div>
                                    <div class="col">
                                        <div class="text-muted small">
                                            Marketplace SKU: <code id="modal-listing-sku"></code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Выберите продукт</label>
                        <select class="form-select" id="product-select">
                            <option value="">Загрузка...</option>
                        </select>
                    </div>

                    <div id="mapping-error" class="alert alert-danger d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="confirm-mapping-btn">Привязать</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapModalElement = document.getElementById('mapListingModal');
            const BootstrapModal = window.bootstrap && typeof window.bootstrap.Modal === 'function'
                ? window.bootstrap.Modal
                : null;
            let currentListingId = null;

            function showMapModal() {
                if (!mapModalElement) {
                    return;
                }

                if (!BootstrapModal) {
                    mapModalElement.classList.add('show');
                    mapModalElement.style.display = 'block';
                    mapModalElement.removeAttribute('aria-hidden');
                    mapModalElement.setAttribute('aria-modal', 'true');
                    return;
                }

                BootstrapModal.getOrCreateInstance(mapModalElement).show();
            }

            if (mapModalElement && !BootstrapModal) {
                mapModalElement.querySelectorAll('[data-bs-dismiss="modal"]').forEach(button => {
                    button.addEventListener('click', function() {
                        mapModalElement.classList.remove('show');
                        mapModalElement.style.display = 'none';
                        mapModalElement.setAttribute('aria-hidden', 'true');
                        mapModalElement.removeAttribute('aria-modal');
                    });
                });
            }

            document.querySelectorAll('.map-listing-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentListingId = this.dataset.listingId;
                    document.getElementById('modal-listing-sku').textContent = this.dataset.listingSku;
                    loadProducts();
                    showMapModal();
                });
            });

            async function loadProducts() {
                const select = document.getElementById('product-select');
                select.innerHTML = '<option value="">Загрузка...</option>';
                try {
                    const response = await fetch('/api/products');
                    const products = await response.json();
                    select.innerHTML = '<option value="">-- Выберите продукт --</option>';
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.sku} - ${product.name}`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    select.innerHTML = '<option value="">Ошибка загрузки</option>';
                }
            }

            document.getElementById('confirm-mapping-btn').addEventListener('click', async function() {
                const productId = document.getElementById('product-select').value;
                const errorDiv = document.getElementById('mapping-error');
                errorDiv.classList.add('d-none');
                if (!productId) {
                    errorDiv.textContent = 'Выберите продукт';
                    errorDiv.classList.remove('d-none');
                    return;
                }
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Привязка...';
                try {
                    const response = await fetch(`/api/marketplace/listings/${currentListingId}/map`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ productId })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        errorDiv.textContent = data.error || 'Не удалось привязать листинг';
                        errorDiv.classList.remove('d-none');
                        this.disabled = false;
                        this.textContent = 'Привязать';
                    }
                } catch (error) {
                    errorDiv.textContent = 'Ошибка сети';
                    errorDiv.classList.remove('d-none');
                    this.disabled = false;
                    this.textContent = 'Привязать';
                }
            });

            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    document.querySelectorAll('tbody tr').forEach(row => {
                        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
                    });
                });
            }
        });
    </script>
{% endblock %}

{% extends 'base.html.twig' %}
{% block title %}P&L Preview{% endblock %}
{% block body %}
<div class="page-body">
  <div class="container-xl">
    {% set groupingLabels = {'day': 'по дням', 'week': 'по неделям', 'month': 'по месяцам'} %}

    <div class="d-flex align-items-center mb-3">
      <h2 class="page-title mb-0">P&L Preview — {{ company.name }} — {{ from|date('d.m.Y') }} — {{ to|date('d.m.Y') }}
        {% if layout == 'projects' %}
          (по проектам)
        {% else %}
          ({{ groupingLabels[grouping] ?? grouping }})
        {% endif %}
      </h2>
    </div>

    <div class="d-flex align-items-center gap-3 mb-3 flex-nowrap">
      <form class="d-flex align-items-center gap-2 flex-nowrap" method="get">
        <select class="form-select" name="grouping">
          <option value="day" {{ grouping == 'day' ? 'selected' }}>
            По дням
          </option>
          <option value="week" {{ grouping == 'week' ? 'selected' }}>
            По неделям
          </option>
          <option value="month" {{ grouping == 'month' ? 'selected' }}>
            По месяцам
          </option>
        </select>
        <select class="form-select" name="layout">
          <option value="periods" {{ layout == 'periods' ? 'selected' }}>По периодам</option>
          <option value="projects" {{ layout == 'projects' ? 'selected' }}>По проектам (Direct)</option>
        </select>
        <select class="form-select" name="projectDirectionId">
          <option value="">Все проекты</option>
          {% for p in projectDirections %}
            <option value="{{ p.id }}" {{ selectedProjectDirectionId == p.id ? 'selected' }}>{{ p.name }}</option>
          {% endfor %}
        </select>
        <input class="form-control" type="date" name="from" value="{{ from|date('Y-m-d') }}">
        <input class="form-control" type="date" name="to" value="{{ to|date('Y-m-d') }}">
        <label class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            name="show_meta"
            value="1"
            {{ showMetaColumns ? 'checked' }}
          >
          <span class="form-check-label">Показывать код и тип</span>
        </label>
        <button class="btn btn-primary">Показать</button>
      </form>

      <form
        class="d-flex align-items-center gap-2 flex-nowrap"
        method="post"
        action="{{ path('finance_report_preview_recalc') }}"
      >
        <input type="hidden" name="_token" value="{{ csrf_token('recalc_pl_preview') }}">
        <input type="hidden" name="grouping" value="{{ grouping }}">
        <input type="hidden" name="from" value="{{ from|date('Y-m-d') }}">
        <input type="hidden" name="to" value="{{ to|date('Y-m-d') }}">
        <input type="hidden" name="recalc_to" value="{{ to|date('Y-m-d') }}">
        <input type="hidden" name="layout" value="{{ layout }}">
        <input type="hidden" name="show_meta" value="{{ showMetaColumns ? 1 : 0 }}">
        <input type="hidden" name="projectDirectionId" value="{{ selectedProjectDirectionId ?? '' }}">
        <label class="form-label mb-0" for="recalc_from">Пересчитать с</label>
        <input
          class="form-control"
          type="date"
          id="recalc_from"
          name="recalc_from"
          value="{{ from|date('Y-m-d') }}"
        >
        <button class="btn btn-outline-primary" type="submit">Пересчитать</button>
      </form>
    </div>

    {% if warnings is not empty %}
    <div class="alert alert-warning mb-3">
      <strong>Предупреждения:</strong>
      <ul class="mb-0">
        {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="card">
      <div class="table-responsive">
        <table class="table table-vcenter">
          {% if layout == 'projects' %}
            <thead>
              <tr>
                <th>Строка</th>
                {% if showMetaColumns %}
                  <th>Код</th>
                  <th>Тип</th>
                {% endif %}
                {% for p in compareProjects %}
                  <th class="text-end">
                    {{ p.name }}{% if p.isOverhead %} <span class="text-muted">(Shared)</span>{% endif %}
                  </th>
                {% endfor %}
                <th class="text-end">Итого</th>
              </tr>
            </thead>
            <tbody>
            {% for r in rows %}
              <tr>
                <td style="padding-left: {{ (r.level - 1) * 20 }}px">{{ r.name }}</td>
                {% if showMetaColumns %}
                  <td><code>{{ r.code ?? '—' }}</code></td>
                  <td>{{ r.type }}</td>
                {% endif %}
                {% for p in compareProjects %}
                  <td class="text-end">{{ r.values[p.id] ?? '—' }}</td>
                {% endfor %}
                <td class="text-end fw-bold">{{ r.values['_total'] ?? '—' }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="{{ 1 + (showMetaColumns ? 2 : 0) + compareProjects|length + 1 }}" class="text-muted">Нет строк отчёта</td>
              </tr>
            {% endfor %}
            </tbody>
          {% else %}
            <thead>
              <tr>
                <th>Строка</th>
                {% if showMetaColumns %}
                  <th>Код</th>
                  <th>Тип</th>
                {% endif %}
                {% for period in periods %}
                  <th class="text-end">{{ period.label }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
            {% for r in rows %}
              <tr>
                <td style="padding-left: {{ (r.level - 1) * 20 }}px">{{ r.name }}</td>
                {% if showMetaColumns %}
                  <td><code>{{ r.code ?? '—' }}</code></td>
                  <td>{{ r.type }}</td>
                {% endif %}
                {% for period in periods %}
                  <td class="text-end">{{ r.values[period.id] ?? '—' }}</td>
                {% endfor %}
              </tr>
            {% else %}
              <tr>
                <td colspan="{{ 1 + (showMetaColumns ? 2 : 0) + periods|length }}" class="text-muted">Нет строк отчёта</td>
              </tr>
            {% endfor %}
            </tbody>
          {% endif %}
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

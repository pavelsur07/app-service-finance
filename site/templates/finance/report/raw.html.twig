{% extends 'base.html.twig' %}
{% block title %}Сырые транзакции ОПиУ (P&L){% endblock %}

{% block body %}
<style>
  .muted { color: #888; }
  .warn  { background: #fff8e1; }
  .ok    { background: #f2fff2; }
  .mono  { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>

<div class="page-body">
  <div class="container-xl">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">Сырые транзакции ОПиУ (P&amp;L) — {{ company.name }} — {{ period|date('Y-m') }}</h3>
        <form class="d-flex" method="get">
          <input class="form-control me-2" type="month" name="period" value="{{ period|date('Y-m') }}">
          <button class="btn btn-primary">Показать</button>
        </form>
      </div>

      <div class="table-responsive">
        <table class="table table-vcenter" id="raw-facts-table">
          <thead>
            <tr>
              <th>Строка</th>
              <th>Код</th>
              <th>Тип</th>
              <th class="text-end">Сырое значение</th>
              <th class="text-end">Комментарий</th>
            </tr>
          </thead>
          <tbody>
          {% for r in rows %}
            {% set pad = (r.level - 1) * 20 %}
            {% set hasCode = r.code is not empty %}
            {% set canProbe = r.isLeaf and hasCode %}
            {% set cls = '' %}
            {% if r.isLeaf and not hasCode %}
              {% set cls = 'warn' %}
            {% elseif canProbe and r.value is not null and r.value != 0 %}
              {% set cls = 'ok' %}
            {% endif %}

            <tr class="{{ cls }}">
              <td style="padding-left: {{ pad }}px">{{ r.name }}</td>
              <td><code class="mono">{{ r.code ?: '—' }}</code></td>
              <td>{{ r.type }}</td>

              <td class="text-end mono">
                {% if r.value is same as(null) %}
                  <span class="muted">n/a</span>
                {% else %}
                  {{ r.value|number_format(2, '.', ' ') }}
                {% endif %}
              </td>

              <td class="text-end">
                {% if r.isLeaf and not hasCode %}
                  <span class="text-warning">Нет кода — факты не подтянутся</span>
                {% elseif canProbe and (r.value is same as(null) or r.value == 0) %}
                  <span class="muted">0 (провайдер вернул 0)</span>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="text-muted">Нет строк</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-footer text-muted">
        Отчёт показывает <strong>прямой результат</strong> вызова FactsProvider для строк типа <code>LEAF_INPUT</code> с заданным <code>code</code>.
        Для строк без кода значение недоступно (<em>n/a</em>).
      </div>
    </div>
  </div>
</div>
{% endblock %}

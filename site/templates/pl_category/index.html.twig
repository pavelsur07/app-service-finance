{% extends 'base.html.twig' %}
{% block title %}–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ P&L{% endblock %}

{% block breadcrumbs %}
    {% include 'partials/_breadcrumbs.html.twig' with {
        breadcrumbs: [
            {'label': '–ì–ª–∞–≤–Ω–∞—è', 'path': 'app_home_index'},
            {'label': '–§–∏–Ω–∞–Ω—Å—ã'},
            {'label': '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏'},
            {'label': '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ P&L'}
        ]
    } %}
{% endblock %}

{% macro render_items(items) %}
    <ul class="pl-category-list list-unstyled mb-0">
    {% for item in items %}
        {% set has_children = item.children|length > 0 %}
        <li class="pl-category-node">
            <div class="pl-category-item d-flex align-items-center">
                {% if has_children %}
                    <button class="pl-category-toggle btn btn-link btn-sm p-0 me-2 collapsed" type="button" aria-expanded="false">
                        <span class="visually-hidden">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </button>
                {% else %}
                    <span class="pl-category-toggle-placeholder me-2"></span>
                {% endif %}
                <a href="{{ path('pl_category_edit', {'id': item.id}) }}" class="pl-category-link text-reset text-decoration-none flex-grow-1">{{ item.name }}</a>
                <span class="ms-auto d-inline-flex gap-1">
                    <form method="post" action="{{ path('pl_category_delete', {'id': item.id}) }}" class="d-inline" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ item.id) }}">
                        <button class="btn btn-sm btn-danger">üóë</button>
                    </form>
                </span>
            </div>
            {% if has_children %}
                <div class="pl-category-children" hidden>
                    {{ _self.render_items(item.children) }}
                </div>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% endmacro %}

{% import _self as macros %}

{% block stylesheets %}
    <style>
        .pl-category-item {
            border-radius: .5rem;
            padding: .5rem .75rem;
            transition: background-color .2s ease-in-out;
        }

        .pl-category-item:hover,
        .pl-category-item:focus-within {
            background-color: rgba(24, 144, 255, 0.12);
        }

        .pl-category-link {
            display: inline-block;
        }

        .pl-category-toggle {
            color: inherit;
            width: 1.5rem;
            height: 1.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .pl-category-toggle::before {
            content: '\25B8';
            font-size: .8rem;
            transition: transform .2s ease-in-out;
        }

        .pl-category-toggle:hover,
        .pl-category-toggle:focus {
            text-decoration: none;
        }

        .pl-category-toggle:not(.collapsed)::before {
            transform: rotate(90deg);
        }

        .pl-category-toggle-placeholder {
            display: inline-flex;
            width: 1.5rem;
            height: 1.5rem;
        }

        .pl-category-children {
            margin-left: 1.5rem;
        }

        .pl-category-json-output {
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: .5rem;
            padding: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: var(--tblr-font-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace);
            max-height: 32rem;
            overflow: auto;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ P&amp;L</h2>
                </div>
                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a href="{{ path('pl_category_new') }}" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</a>
                        <button type="button" class="btn btn-outline-secondary" data-export-json="{{ path('pl_category_export_json') }}">
                            –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-xl mt-3">
        <div class="card">
            <div class="card-body">
                {{ macros.render_items(items) }}
                <pre id="pl-category-json-output" class="pl-category-json-output mt-4" hidden></pre>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var exportButton = document.querySelector('[data-export-json]');
            var exportOutput = document.getElementById('pl-category-json-output');

            if (exportButton && exportOutput) {
                exportButton.addEventListener('click', function (event) {
                    event.preventDefault();
                    var endpoint = exportButton.getAttribute('data-export-json');
                    if (!endpoint) {
                        return;
                    }

                    exportButton.setAttribute('disabled', 'disabled');
                    exportButton.classList.add('disabled');

                    fetch(endpoint, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                return response.text().then(function (text) {
                                    throw new Error(text || response.statusText);
                                });
                            }

                            return response.json();
                        })
                        .then(function (data) {
                            exportOutput.textContent = JSON.stringify(data, null, 2);
                            exportOutput.hidden = false;
                            exportOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        })
                        .catch(function (error) {
                            exportOutput.textContent = '–û—à–∏–±–∫–∞ –≤—ã–≥—Ä—É–∑–∫–∏: ' + error.message;
                            exportOutput.hidden = false;
                        })
                        .finally(function () {
                            exportButton.removeAttribute('disabled');
                            exportButton.classList.remove('disabled');
                        });
                });
            }

            document.querySelectorAll('.pl-category-toggle').forEach(function (button) {
                button.addEventListener('click', function () {
                    var node = button.closest('.pl-category-node');
                    if (!node) {
                        return;
                    }

                    var children = null;
                    for (var i = 0; i < node.children.length; i++) {
                        var child = node.children[i];
                        if (child.classList && child.classList.contains('pl-category-children')) {
                            children = child;
                            break;
                        }
                    }

                    if (!children) {
                        return;
                    }

                    var isHidden = children.hasAttribute('hidden');
                    if (isHidden) {
                        children.removeAttribute('hidden');
                    } else {
                        children.setAttribute('hidden', '');
                    }

                    button.classList.toggle('collapsed', !isHidden);
                    button.setAttribute('aria-expanded', String(isHidden));
                });
            });
        });
    </script>
{% endblock %}

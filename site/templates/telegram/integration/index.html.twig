{% extends 'base.html.twig' %}

{% block title %}Интеграция с Telegram{% endblock %}

{% block body %}
<div class="container-xl">
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <h2 class="page-title">Telegram / Финансы</h2>
        <div class="text-secondary">Создайте ссылку привязки для активной компании: <strong>{{ company.name }}</strong>.</div>
      </div>
    </div>
  </div>

  {% for label, messages in app.flashes %}
    {% for message in messages %}
      <div class="alert alert-{{ label }} my-2" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endfor %}

  <div class="row row-cards">
    <div class="col-md-8">
      <div class="card">
        <div class="card-status-top bg-primary"></div>
        <div class="card-header">
          <h3 class="card-title">Привязка Telegram-бота</h3>
            <div class="ms-auto">
            {% if isBound %}
              <span class="badge bg-success text-white">Привязка выполнена</span>
            {% else %}
              <span class="badge bg-secondary">Не привязано</span>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          {% if bot %}
            <p class="text-secondary mb-3">
              Активный бот: <strong>{{ bot.username ? '@' ~ bot.username|trim('@') : 'без username' }}</strong>.
            </p>
          {% else %}
            <div class="alert alert-warning" role="alert">
              Администратор сервиса ещё не настроил Telegram-бота
            </div>
          {% endif %}

          <form method="post" action="{{ path('telegram_integration_generate_link') }}">
            <input type="hidden" name="_token" value="{{ csrf_token('telegram_generate_link') }}">
            <button class="btn btn-primary" type="submit" {% if not bot %}disabled{% endif %}>
              Сгенерировать ссылку привязки
            </button>
          </form>

          {% if deepLinkWeb %}
            <div class="alert alert-success mt-4" role="alert">
              Ссылка привязки готова. Если Telegram открылся без ключа — вставьте команду вручную: {{ startCommand }}
              <div class="text-secondary mt-2">
                Если бот уже запускался — параметр start может не примениться. Тогда отправьте команду вручную: {{ startCommand }} или вставьте токен отдельным сообщением.
              </div>
              <div class="mt-3 btn-list">
                <a class="btn btn-primary" href="{{ deepLinkApp }}">Открыть Telegram и привязать</a>
                <a class="btn btn-secondary" href="{{ deepLinkWeb }}" target="_blank" rel="noopener noreferrer">Открыть в браузере</a>
                <button class="btn btn-light" type="button" data-copy-text="{{ startCommand }}">Скопировать команду</button>
              </div>
            </div>
          {% endif %}

          {% if usernameMissing %}
            <div class="alert alert-warning mt-2" role="alert">
              Заполните username в /admin
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{# Небольшой inline-скрипт для копирования команды в буфер обмена #}
{% block javascripts %}
  {{ parent() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const copyButtons = document.querySelectorAll('[data-copy-text]');

      copyButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const text = button.getAttribute('data-copy-text');

          if (!text) {
            return;
          }

          navigator.clipboard.writeText(text).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Скопировано';

            // Возвращаем исходный текст через короткую задержку, чтобы пользователь понял, что копирование прошло.
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          });
        });
      });
    });
  </script>
{% endblock %}

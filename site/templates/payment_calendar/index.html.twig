{% extends 'base.html.twig' %}

{% block title %}Платёжный календарь{% endblock %}

{% block body %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
    <div>
        <h1 class="mb-1">Платёжный календарь</h1>
        {% if period %}
            <div class="text-muted">Период: {{ period.from|date('Y-m-d') }} — {{ period.to|date('Y-m-d') }}</div>
        {% endif %}
    </div>
    <div class="mt-3 mt-md-0">
        <a class="btn btn-primary" href="{{ path('payment_calendar_new', filterQuery) }}">Добавить</a>
    </div>
</div>

<form method="get" class="card card-body mb-4">
    <div class="row g-3">
        <div class="col-sm-6 col-lg-3">
            <label for="filter-from" class="form-label">С</label>
            <input type="date" id="filter-from" name="from" class="form-control" value="{{ filters.from }}" required>
        </div>
        <div class="col-sm-6 col-lg-3">
            <label for="filter-to" class="form-label">По</label>
            <input type="date" id="filter-to" name="to" class="form-control" value="{{ filters.to }}" required>
        </div>
        <div class="col-sm-6 col-lg-3">
            <label for="filter-account" class="form-label">Счёт</label>
            <select id="filter-account" name="account_id" class="form-select">
                <option value="">Все</option>
                {% for account in accounts %}
                    <option value="{{ account.id }}" {% if filters.account_id == account.id %}selected{% endif %}>{{ account.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-6 col-lg-3">
            <label for="filter-category" class="form-label">Категория</label>
            <select id="filter-category" name="category_id" class="form-select">
                <option value="">Все</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if filters.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-6 col-lg-3">
            <label for="filter-status" class="form-label">Статус</label>
            <select id="filter-status" name="status" class="form-select">
                <option value="">Все</option>
                {% for value, label in statuses %}
                    <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-6 col-lg-3">
            <label for="filter-counterparty" class="form-label">Контрагент</label>
            <select id="filter-counterparty" name="counterparty_id" class="form-select">
                <option value="">Все</option>
                {% for counterparty in counterparties %}
                    <option value="{{ counterparty.id }}" {% if filters.counterparty_id == counterparty.id %}selected{% endif %}>{{ counterparty.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Применить</button>
            <a href="{{ path('payment_calendar_index', {'from': filters.from, 'to': filters.to}) }}" class="btn btn-outline-secondary">Сбросить дополнительные фильтры</a>
        </div>
    </div>
</form>

<div class="card">
    <div class="table-responsive">
        <table class="table card-table table-vcenter">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Категория</th>
                    <th>Контрагент</th>
                    <th class="text-end">Сумма</th>
                    <th>Счёт</th>
                    <th>Статус</th>
                    <th>Комментарий</th>
                    <th class="w-1">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for plan in plans %}
                    <tr>
                        <td>{{ plan.plannedAt|date('Y-m-d') }}</td>
                        <td>{{ plan.cashflowCategory.name }}</td>
                        <td>{{ plan.counterparty ? plan.counterparty.name : '—' }}</td>
                        <td class="text-end">{{ plan.amount|number_format(2, '.', ' ') }}</td>
                        <td>{{ plan.moneyAccount ? plan.moneyAccount.name : '—' }}</td>
                        <td>{{ plan.status.value }}</td>
                        <td>{{ plan.comment ?? '' }}</td>
                        <td>
                            <a class="btn btn-link p-0" href="{{ path('payment_calendar_edit', filterQuery|merge({'id': plan.id})) }}">Редактировать</a>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">Записей не найдено</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if showForm is defined and showForm and form is defined %}
    <div class="card mt-4">
        <div class="card-header">
            <h2 class="card-title mb-0">{{ formTitle ?? 'Запись' }}</h2>
        </div>
        <div class="card-body">
            {% include 'payment_calendar/_form.html.twig' with {form: form, filterQuery: filterQuery} %}
        </div>
    </div>
{% endif %}
{% endblock %}

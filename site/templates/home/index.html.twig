{% extends 'base.html.twig' %}

{% block title %}Главная{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    .card-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: #626976;
      text-transform: uppercase;
    }

    .card-body-p-0 {
      padding: 1.25rem 0 0 0 !important;
    }

    .card-body-p-0 .px-3 {
      padding-left: 1.25rem !important;
      padding-right: 1.25rem !important;
    }

    .chart-sparkline {
      width: 100% !important;
      margin-top: 15px;
    }

    .kpi-trend {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.875rem;
      font-weight: 600;
      margin-top: 0.35rem;
    }

    .kpi-trend i {
      font-size: 1rem;
    }
  </style>
{% endblock %}

{% block content %}
    <a class="btn btn-primary" href="{{ path('debug_log_test') }}"> Test Logs</a>
<div class="row row-deck row-cards mb-4 ">
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Остаток на сегодня</div>
        <div class="h1 mb-0">{{ kpi.todayBalance|number_format(0, '.', ' ') }} ₽</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Приход (30 дней)</div>
        <div class="h1 mb-0">{{ kpi.inflow30|number_format(0, '.', ' ') }} ₽</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Расход (30 дней)</div>
        <div class="h1 mb-0">{{ kpi.outflow30|number_format(0, '.', ' ') }} ₽</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <div class="subheader">Чистый поток (30 дней)</div>
        <div class="h1 mb-0">{{ (kpi.inflow30 - kpi.outflow30)|number_format(0, '.', ' ') }} ₽</div>
      </div>
    </div>
  </div>
</div>

    <div class="row g-3 mb-4">
        <div class="card mt-3">
            <div class="card-body">
                <div id="react-dashboard-started"></div>
            </div>
        </div>
    </div>

{#<div class="row g-3 mb-4">
  <div class="card mt-3">
    <div class="card-body">
      <form method="post" action="{{ path('dashboard_notify') }}" style="display:inline;">
        <input type="hidden" name="_token" value="{{ csrf_token('dashboard_notify') }}">
        <button type="submit" class="btn btn-primary me-2">
          Отправить уведомление
        </button>
      </form>
      <a href="{{ path('cash_bank1c_import_upload') }}" class="btn btn-primary me-2">Импорт 1С</a>
      <a href="{{ path('report_cashflow_index') }}" class="btn btn-outline-primary me-2">Отчёт ДДС</a>
      <a href="{{ path('payment_calendar_index') }}" class="btn btn-outline-primary">Платёжный календарь</a>
    </div>
  </div>

    #}{# ... твои виджеты/карточки ... #}{#
    {% include 'dashboard/_money_balance_chart.html.twig' %}
    #}{# ... другие блоки ... #}{#
    {% include 'dashboard/_demo_chart.html.twig' %}
</div>#}

{#<div class="page-header d-print-none mt-4">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">Финансовый мониторинг SMB</h2>
      </div>
    </div>
  </div>
</div>#}

{#<div class="page-body">
  <div class="container-xl">
    <div class="row row-cards mb-3">
      <div class="col-sm-6 col-lg-3">
        <div class="card">
          <div class="card-body card-body">
            <div class="px-3">
              <div class="subheader">Остаток на счетах (Cash)</div>
              <div class="h1 mb-0">4 850 000 ₽</div>
              <div class="kpi-trend text-success">
                <span>+4%</span>
                <i class="ti ti-trending-up" aria-hidden="true"></i>
                <span>Прирост за период</span>
              </div>
            </div>
            <div id="chart-cash-sparkline" class="chart-sparkline"></div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card">
          <div class="card-body card-body-p-0">
            <div class="px-3">
              <div class="subheader">Чистая прибыль (LTM)</div>
              <div class="h1 mb-0">1 240 000 ₽</div>
              <div class="kpi-trend text-danger">
                <span>-1%</span>
                <i class="ti ti-trending-down" aria-hidden="true"></i>
                <span>Снижение за период</span>
              </div>
            </div>
            <div id="chart-profit-sparkline" class="chart-sparkline"></div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card">
          <div class="card-body">
            <div class="subheader">Дебиторка (Просроч.)</div>
            <div class="h1 mb-3 text-danger">320 000 ₽</div>
            <div class="progress progress-sm">
              <div class="progress-bar bg-danger" style="width: 15%"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-6 col-lg-3">
        <div class="card">
          <div class="card-body">
            <div class="subheader">Точка безубыточности</div>
            <div class="h1 mb-3">2 100 000 ₽</div>
            <div class="text-blue small fw-bold">Пройдена 18 числа</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row row-cards mb-3">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body card-body-p-0">
            <div class="px-3">
              <div class="subheader text-success">Приход (30 дней)</div>
              <div class="h2 mb-0">3 120 000 ₽</div>
            </div>
            <div id="chart-inflow-sparkline" class="chart-sparkline"></div>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body card-body-p-0">
            <div class="px-3">
              <div class="subheader text-danger">Расход (30 дней)</div>
              <div class="h2 mb-0">2 450 000 ₽</div>
            </div>
            <div id="chart-outflow-sparkline" class="chart-sparkline"></div>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body card-body-p-0">
            <div class="px-3">
              <div class="subheader text-primary">Чистый поток (30 дней)</div>
              <div class="h2 mb-0">+ 670 000 ₽</div>
            </div>
            <div id="chart-netflow-sparkline" class="chart-sparkline"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row row-cards mb-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h3 class="card-title">Выполнение плана по выручке</h3>
            <div class="d-flex align-items-end mb-2">
              <div class="h2 mb-0 me-2">8.2 млн / 10 млн</div>
              <div class="ms-auto text-muted small">82%</div>
            </div>
            <div class="progress progress-sm">
              <div class="progress-bar bg-primary" style="width: 82%"></div>
            </div>
            <div class="mt-3 small text-success fw-bold">Прогноз: 10.5 млн ₽</div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h3 class="card-title">Выполнение плана по марже</h3>
            <div class="d-flex align-items-end mb-2">
              <div class="h2 mb-0 me-2">35% / 40%</div>
              <div class="ms-auto text-muted small">87%</div>
            </div>
            <div class="progress progress-sm">
              <div class="progress-bar bg-yellow" style="width: 87%"></div>
            </div>
            <div class="mt-3 small text-danger fw-bold">Прогноз: 38%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row row-cards mb-3">
      <div class="col-lg-6">
        <div class="card">
          <div class="card-body">
            <h3 class="card-title">Структура доходов</h3>
            <div id="chart-income-pie"></div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <div class="card-body">
            <h3 class="card-title">Структура затрат</h3>
            <div id="chart-expense-pie"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Движение денег (Cash Flow)</h3>
          </div>
          <div class="card-body">
            <div id="chart-cashflow"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Динамика валовой прибыли</h3>
          </div>
          <div class="card-body">
            <div id="chart-gross-profit"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>#}

{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sparkBase = {
        chart: { type: 'bar', height: 40, sparkline: { enabled: true }, animations: { enabled: false } },
        plotOptions: { bar: { columnWidth: '85%' } },
        tooltip: { fixed: { enabled: false }, x: { show: false }, y: { title: { formatter: () => '' } } }
      };

      new ApexCharts(
        document.querySelector("#chart-cash-sparkline"),
        { ...sparkBase, series: [{ data: [30, 40, 35, 50, 49, 60, 70, 91, 125,40, 35, 50, 49,50, 49, 60, 70, 91, 125] }], colors: ['#206bc4'] }
      ).render();
      new ApexCharts(
        document.querySelector("#chart-profit-sparkline"),
        { ...sparkBase, series: [{ data: [10, 20, 15, 30, 25, 45, 50, 60, 75] }], colors: ['#2fb344'] }
      ).render();

      new ApexCharts(
        document.querySelector("#chart-inflow-sparkline"),
        { ...sparkBase, series: [{ data: [50, 60, 70, 40, 30, 80, 90, 100, 110] }], colors: ['#2fb344'] }
      ).render();
      new ApexCharts(
        document.querySelector("#chart-outflow-sparkline"),
        { ...sparkBase, series: [{ data: [40, 30, 50, 60, 55, 40, 30, 50, 45] }], colors: ['#d63939'] }
      ).render();
      new ApexCharts(
        document.querySelector("#chart-netflow-sparkline"),
        { ...sparkBase, series: [{ data: [10, 30, 20, -10, 25, 40, 60, 50, 65] }], colors: ['#206bc4'] }
      ).render();

      new ApexCharts(
        document.querySelector("#chart-income-pie"),
        {
          chart: { type: 'donut', height: 280 },
          series: [60, 30, 10],
          labels: ['Товары', 'Услуги', 'Прочее'],
          colors: ['#206bc4', '#4299e1', '#bfe399'],
          legend: { position: 'bottom' }
        }
      ).render();
      new ApexCharts(
        document.querySelector("#chart-expense-pie"),
        {
          chart: { type: 'donut', height: 280 },
          series: [45, 25, 15, 15],
          labels: ['ФОТ', 'Маркетинг', 'Аренда', 'Налоги'],
          colors: ['#d63939', '#f76707', '#fab005', '#ae3ec9'],
          legend: { position: 'bottom' }
        }
      ).render();
      new ApexCharts(
        document.querySelector("#chart-cashflow"),
        {
          chart: { type: 'bar', height: 320, toolbar: { show: false } },
          series: [
            { name: 'Приход', data: [40, 50, 41, 50, 48, 60, 70] },
            { name: 'Расход', data: [30, 35, 32, 38, 40, 45, 50] }
          ],
          colors: ['#2fb344', '#d63939'],
          xaxis: { categories: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'] }
        }
      ).render();
      new ApexCharts(
        document.querySelector("#chart-gross-profit"),
        {
          chart: { type: 'area', height: 300, toolbar: { show: false } },
          series: [{ name: 'Маржа', data: [30, 45, 35, 55, 40, 80, 95] }],
          colors: ['#206bc4'],
          xaxis: { categories: ['Нед 1', 'Нед 2', 'Нед 3', 'Нед 4', 'Нед 5', 'Нед 6', 'Нед 7'] }
        }
      ).render();
    });
  </script>
{% endblock %}

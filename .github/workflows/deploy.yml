name: ğŸš€ Deploy to Production

on:
    push:
        branches: [ master ]
    pull_request:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¦ Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ›  Install zip
              run: sudo apt-get install -y zip

            - name: ğŸ” Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: ğŸ“¦ Create deploy archive
              run: |
                  zip -r app.zip . \
                    -x "vendor/*" \
                    -x "var/*" \
                    -x "node_modules/*" \
                    -x "app.zip"

            - name: ğŸ“¤ Upload archive to server
              run: |
                  scp -o StrictHostKeyChecking=no app.zip ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_DIR }}

            - name: ğŸš€ Deploy application
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    set -e

                    cd ${{ secrets.SERVER_DIR }}

                    echo "ğŸ“¦ Ğ Ğ°ÑĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ° Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°"
                    rm -rf ./current
                    mkdir -p ./current
                    unzip -o app.zip -d ./current
                    rm app.zip

                    echo "ğŸ³ Ğ—Ğ°Ğ¿ÑƒÑĞº docker-compose"
                    cd ./current

                    APP_ENV="${{ secrets.APP_ENV }}" \
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    SITE_MAILER_DSN="${{ secrets.SITE_MAILER_DSN }}" \
                    docker compose -f docker-compose.prod.yml up -d --build

                    echo "âœ… Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½"
                  EOF

    migrations:
        needs: deploy
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ” Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: ğŸ• Wait for services to be ready
              run: sleep 5

            - name: ğŸ§¬ Run Doctrine migrations
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    echo "ğŸš§ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸"
                    cd ${{ secrets.SERVER_DIR }}/current

                    APP_ENV="${{ secrets.APP_ENV }}" \
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    SITE_MAILER_DSN="${{ secrets.SITE_MAILER_DSN }}" \
                    docker compose -f docker-compose.prod.yml run --rm site-php-cli bin/console doctrine:migrations:migrate --no-interaction
                    echo "âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹"
                  EOF

    migrations-empty-db:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_DB: app
                    POSTGRES_USER: app
                    POSTGRES_PASSWORD: app
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready -U app -d app"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
            redis:
                image: redis:7-alpine
                ports:
                    - "6379:6379"
                options: >-
                    --health-cmd="redis-cli ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=10

        steps:
            - name: ğŸ“¦ Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ˜ Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.2
                  tools: composer

            - name: ğŸ“¦ Install dependencies
              working-directory: site
              run: composer install --no-interaction --prefer-dist --no-progress --no-scripts

            - name: Install psql client
              run: |
                  sudo apt-get update
                  sudo apt-get install -y postgresql-client

            - name: Create test database (app_test)
              env:
                  PGPASSWORD: app
              run: |
                  set -e
                  if psql -h 127.0.0.1 -p 5432 -U app -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='app_test'" | grep -q 1; then
                    echo "Database app_test already exists"
                  else
                    echo "Creating database app_test"
                    psql -h 127.0.0.1 -p 5432 -U app -d postgres -c "CREATE DATABASE app_test"
                  fi

            - name: ğŸ§¬ Run Doctrine migrations
              working-directory: site
              env:
                  APP_ENV: test
                  APP_DEBUG: 0
                  DATABASE_URL: "pgsql://app:app@127.0.0.1:5432/app?serverVersion=16&charset=utf8"
                  REDIS_DSN: "redis://127.0.0.1:6379"
                  MESSENGER_TRANSPORT_DSN: "redis://127.0.0.1:6379/messages"
              run: php bin/console doctrine:migrations:migrate --no-interaction

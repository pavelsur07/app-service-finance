name: üöÄ Deploy to Production

on:
    push:
        branches: [ master ]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: üì¶ Checkout repository
              uses: actions/checkout@v4

            - name: üõ† Install zip
              run: sudo apt-get install -y zip

            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üì¶ Create deploy archive
              run: |
                  zip -r app.zip . \
                    -x "vendor/*" \
                    -x "var/*" \
                    -x "node_modules/*" \
                    -x "app.zip"

            - name: üì§ Upload archive to server
              run: |
                  scp -o StrictHostKeyChecking=no app.zip ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_DIR }}

            - name: üöÄ Deploy application
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    set -e

                    cd ${{ secrets.SERVER_DIR }}

                    echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞"
                    rm -rf ./current
                    mkdir -p ./current
                    unzip -o app.zip -d ./current
                    rm app.zip

                    echo "üê≥ –ó–∞–ø—É—Å–∫ docker-compose"
                    cd ./current

                    APP_ENV="${{ secrets.APP_ENV }}" \
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    SITE_MAILER_DSN="${{ secrets.SITE_MAILER_DSN }}" \
                    docker compose -f docker-compose.prod.yml up -d --build

                    echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
                  EOF

    migrations:
        needs: deploy
        runs-on: ubuntu-latest

        steps:
            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üïê Wait for services to be ready
              run: sleep 5

            - name: üß¨ Run Doctrine migrations
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    echo "üöß –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏"
                    cd ${{ secrets.SERVER_DIR }}/current

                    APP_ENV="${{ secrets.APP_ENV }}" \
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    docker compose -f docker-compose.prod.yml run --rm site-php-cli bin/console doctrine:migrations:migrate --no-interaction
                    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
                  EOF

    promote-super-admin:
        needs: migrations
        runs-on: ubuntu-latest

        steps:
            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üë§ Promote pavelsur78@mail.ru to super admin
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    set -e
                    echo "üë§ –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º"
                    cd ${{ secrets.SERVER_DIR }}/current

                    set +e
                    PROMOTE_OUTPUT=$(APP_ENV="${{ secrets.APP_ENV }}" \
                      APP_SECRET="${{ secrets.APP_SECRET }}" \
                      DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                      POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                      SITE_MAILER_DSN="${{ secrets.SITE_MAILER_DSN }}" \
                      docker compose -f docker-compose.prod.yml run --rm site-php-cli php bin/console app:user:promote-super-admin pavelsur78@mail.ru -q 2>&1)
                    PROMOTE_EXIT_CODE=$?
                    set -e

                    if [ $PROMOTE_EXIT_CODE -ne 0 ]; then
                      if echo "$PROMOTE_OUTPUT" | grep -qi "already"; then
                        echo "‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º"
                      else
                        echo "$PROMOTE_OUTPUT"
                        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º (–∫–æ–¥ $PROMOTE_EXIT_CODE)"
                        exit $PROMOTE_EXIT_CODE
                      fi
                    else
                      echo "$PROMOTE_OUTPUT"
                      echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º"
                    fi
                  EOF


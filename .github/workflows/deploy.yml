name: üöÄ Deploy to Production

on:
    push:
        branches: [ master ]
    pull_request:
jobs:
    # 1. –≠–¢–ê–ü –°–ë–û–†–ö–ò: –ó–∞–ø—É—Å–∫–∞–µ–º 4 —Å–±–æ—Ä–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    build-and-push:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false # –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–±–æ—Ä–∫—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö, –µ—Å–ª–∏ –æ–¥–∏–Ω —É–ø–∞–ª
            matrix:
                include:
                    - service: landing
                      context: ./landing
                      file: ./landing/docker/production/nginx/Dockerfile
                      tag: land-nginx:latest
                    - service: site-nginx
                      context: ./site
                      file: ./site/docker/production/nginx/Dockerfile
                      tag: site-nginx:latest
                    - service: site-php-fpm
                      context: ./site
                      file: ./site/docker/production/php-fpm/Dockerfile
                      tag: site-php-fpm:latest
                    - service: site-php-cli
                      context: ./site
                      file: ./site/docker/production/php-cli/Dockerfile
                      tag: site-php-cli:latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: üì¶ Checkout repository
              uses: actions/checkout@v4

            - name: üîê Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: üõ† Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: üõ† Build and Push ${{ matrix.service }}
              uses: docker/build-push-action@v5
              with:
                  context: ${{ matrix.context }}
                  file: ${{ matrix.file }}
                  push: true
                  tags: ghcr.io/pavelsur07/${{ matrix.tag }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # 2. –≠–¢–ê–ü –î–ï–ü–õ–û–Ø
    deploy:
        needs: build-and-push # –ñ–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –í–°–ï–• —Å–±–æ—Ä–æ–∫ –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã
        runs-on: ubuntu-latest
        steps:
            - name: üì¶ Checkout repository
              uses: actions/checkout@v4

            - name: üõ† Install zip
              run: sudo apt-get install -y zip

            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üì¶ Create deploy archive (Configs only)
              run: |
                  zip -r app.zip docker-compose.prod.yml docker/

            - name: üì§ Upload archive to server
              run: |
                  scp -o StrictHostKeyChecking=no app.zip ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_DIR }}

            - name: üöÄ Deploy application
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    set -e
                    cd ${{ secrets.SERVER_DIR }}

                    echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞"
                    rm -rf ./current
                    mkdir -p ./current
                    unzip -o app.zip -d ./current
                    rm app.zip

                    cd ./current

                    echo "üöö –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–≤–µ–∂–∏—Ö –æ–±—Ä–∞–∑–æ–≤ –∏–∑ GHCR"
                    docker compose -f docker-compose.prod.yml pull land site site-php-fpm site-php-cli

                    echo "üê≥ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
                    APP_ENV="${{ secrets.APP_ENV }}" \
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    SITE_MAILER_DSN="${{ secrets.SITE_MAILER_DSN }}" \
                    docker compose -f docker-compose.prod.yml up -d --remove-orphans

                    echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–ª–æ–µ–≤ Docker"
                    docker image prune -f
                    echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
                  EOF

    # 3. –≠–¢–ê–ü –ú–ò–ì–†–ê–¶–ò–ô
    migrations:
        needs: deploy
        runs-on: ubuntu-latest
        steps:
            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üïê Wait for services to be ready
              run: sleep 5

            - name: üß¨ Run Doctrine migrations
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
                    echo "üöß –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏"
                    cd ${{ secrets.SERVER_DIR }}/current

                    APP_ENV="${{ secrets.APP_ENV }}" \
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    DATABASE_URL="${{ secrets.DATABASE_URL }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    SITE_MAILER_DSN="${{ secrets.SITE_MAILER_DSN }}" \
                    docker compose -f docker-compose.prod.yml run --rm site-php-cli bin/console doctrine:migrations:migrate --no-interaction
                    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
                  EOF

    # 4. –¢–ï–°–¢–´ –ù–ê –ü–£–°–¢–û–ô –ë–î
    migrations-empty-db:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_DB: app
                    POSTGRES_USER: app
                    POSTGRES_PASSWORD: app
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd="pg_isready -U app -d app"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5
            redis:
                image: redis:7-alpine
                ports:
                    - "6379:6379"
                options: >-
                    --health-cmd="redis-cli ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=10

        steps:
            - name: üì¶ Checkout repository
              uses: actions/checkout@v4

            - name: üêò Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.2
                  tools: composer

            - name: üì¶ Install dependencies
              working-directory: site
              run: composer install --no-interaction --prefer-dist --no-progress --no-scripts

            - name: Install psql client
              run: |
                  sudo apt-get update
                  sudo apt-get install -y postgresql-client

            - name: Create test database (app_test)
              env:
                  PGPASSWORD: app
              run: |
                  set -e
                  if psql -h 127.0.0.1 -p 5432 -U app -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='app_test'" | grep -q 1; then
                    echo "Database app_test already exists"
                  else
                    echo "Creating database app_test"
                    psql -h 127.0.0.1 -p 5432 -U app -d postgres -c "CREATE DATABASE app_test"
                  fi

            - name: üß¨ Run Doctrine migrations
              working-directory: site
              env:
                  APP_ENV: test
                  APP_DEBUG: 0
                  DATABASE_URL: "pgsql://app:app@127.0.0.1:5432/app?serverVersion=16&charset=utf8"
                  REDIS_DSN: "redis://127.0.0.1:6379"
                  MESSENGER_TRANSPORT_DSN: "redis://127.0.0.1:6379/messages"
              run: php bin/console doctrine:migrations:migrate --no-interaction
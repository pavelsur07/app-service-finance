#!/bin/bash

# =============================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =============================

SERVER_USER=root                # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH
SERVER_HOST=217.198.13.171      # IP –∏–ª–∏ –¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞
SERVER_DIR=/srv/2bstock-app     # –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ENV_FILE=.env.prod            # –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å env

# =======================================
# üì¶ –®–∞–≥ 1: –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ –±–µ–∑ vendor/ –∏ var/
# =======================================
echo "üöÄ –°–æ–∑–¥–∞—é —á–∏—Å—Ç—ã–π –∞—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–∞ –±–µ–∑ vendor/, var/ –∏ node_modules/"

zip -r app.zip . \
  -x "vendor/*" \
  -x "var/*" \
  -x "node_modules/*" \
  -x "app.zip"

echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: app.zip"

# =======================================
# üì§ –®–∞–≥ 2: –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤ –∏ .env.prod
# =======================================
echo "üöÄ –ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ–µ–∫—Ç –∏ .env.prod –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

scp app.zip $SERVER_USER@$SERVER_HOST:$SERVER_DIR
scp $ENV_FILE $SERVER_USER@$SERVER_HOST:$SERVER_DIR

echo "‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# =======================================
# üóÇÔ∏è –®–∞–≥ 3: –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# =======================================
echo "üöÄ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –ø–æ SSH –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é –ø—Ä–æ–µ–∫—Ç..."

ssh $SERVER_USER@$SERVER_HOST << EOF
  set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

  cd $SERVER_DIR

  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ unzip, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ..."
  if ! command -v unzip &> /dev/null; then
    sudo apt-get update && sudo apt-get install -y unzip
  fi

  echo "üóëÔ∏è –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É current..."
  rm -rf ./current

  echo "üìÇ –°–æ–∑–¥–∞—é –Ω–æ–≤—É—é –ø–∞–ø–∫—É current –∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—é –ø—Ä–æ–µ–∫—Ç..."
  mkdir -p ./current
  unzip -o app.zip -d ./current
  rm app.zip

  echo "üìÑ –ö–æ–ø–∏—Ä—É—é .env.prod –≤–Ω—É—Ç—Ä—å –∫–∞—Ç–∞–ª–æ–≥–∞ site/"
  cp $ENV_FILE ./current/site/.env

  echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏:"
  ls -la ./current

  echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —á—Ç–æ –ø–∞–ø–∫–∞ site —Å—É—â–µ—Å—Ç–≤—É–µ—Ç..."
  if [ ! -d "./current/site" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –ü–∞–ø–∫–∞ 'site' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ ./current!"
    exit 1
  fi

  echo "üê≥ –ó–∞–ø—É—Å–∫–∞—é docker-compose.prod.yml..."
  cd ./current
  docker compose -f docker-compose.prod.yml --env-file ./site/.env up -d --build

  echo "‚úÖ –î–µ–ø–ª–æ–π –∏ –∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
EOF

echo "üöÄ –í—Å—ë –≥–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: docker ps"

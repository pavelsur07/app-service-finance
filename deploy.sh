#!/bin/bash

# =============================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =============================

SERVER_USER=root          # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è SSH
SERVER_HOST=217.198.13.171    # IP –∏–ª–∏ –¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞
SERVER_DIR=/srv/2bstock-app    # –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ENV_FILE=".env.prod"              # –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å env

# =============================
# –®–∞–≥ 1: –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ –±–µ–∑ vendor/ –∏ var/
# =============================

echo "üöÄ –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–±–µ–∑ vendor/ –∏ var/)..."

zip -r app.zip . \
  -x "vendor/*" \
  -x "var/*" \
  -x "node_modules/*" \
  -x "app.zip"

# =============================
# –®–∞–≥ 2: –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤ –∏ env
# =============================

echo "üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

scp app.zip $SERVER_USER@$SERVER_HOST:$SERVER_DIR

echo "üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

scp $ENV_FILE $SERVER_USER@$SERVER_HOST:$SERVER_DIR

# =============================
# –®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
# =============================

echo "üöÄ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."

ssh $SERVER_USER@$SERVER_HOST << EOF
  cd $SERVER_DIR

  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º unzip..."
  if ! command -v unzip &> /dev/null
  then
    echo "üõ†Ô∏è unzip –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    sudo apt-get update && sudo apt-get install -y unzip
  else
    echo "‚úÖ unzip —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  fi

  echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–¥..."
  rm -rf ./current
  mkdir -p current

  echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
  unzip -o app.zip -d ./current
  rm app.zip

  echo "üìÑ –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
  cp $ENV_FILE ./current/.env

  cd current

  echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º docker-compose.prod.yml..."
  docker compose -f docker-compose.prod.yml --env-file .env up -d --build

  echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
EOF

echo "üöÄ –í—Å—ë –≥–æ—Ç–æ–≤–æ!"
